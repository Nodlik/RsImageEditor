!function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["color.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Color</h2>\n</div>\n<div class="m__color-item">\n    Brightness\n    <div id="brightnessSlider"></div>\n</div>\n<div class="m__color-item">\n    Vibrance\n    <div id="vibranceSlider"></div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["crop.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <button id="crop_ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize-grid.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <input class="m_resize-width" type="text" placeholder="width" value="150" /> <br />\n    <input class="m_resize-height" type="text" placeholder="height"value="100" /> <br /> <br />\n\n    <button class="m_resize-ok" value="ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize-single.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Size</h2>\n</div>\n\n<div class="m__single-resize">\n    <div class="m__single-resize__val width">\n        Width <br />\n        <input type="number" /> px\n    </div>\n\n    <div class="m__single-resize__lock">\n        <i class="\n        ',h+=d.contextOrFrameLookup(b,c,"isLocked")?"\n        fa fa-lock\n        ":"\n        fa fa-unlock\n        ",h+='"></i>\n    </div>\n\n    <div class="m__single-resize__val height">\n        Height <br />\n        <input type="number" /> px\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["editor.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-editor-block">\n    <input type="file" id="rsFileInput" style="display: none" multiple />\n    <div id="rsToolbarPlace" class="rs-toolbar"></div>\n    <div class="rs-progress-bar" id="rsProgressBar">\n\n    </div>\n    <div class="rs-content">\n        <div id="rsImagePlace" class="rs-image-place"></div>\n        <div class="rs-popover">\n            <div id="rsPopover"></div>\n            <div id="rsInformation" class="rs-information">\n\n            </div>\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-image" data-id="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"id",a.autoesc),a.autoesc),h+='">\n    <div class="rs-image-block">\n        <!--<img src="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='" />-->\n        <!--',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='-->\n    </div>\n    <div class="rs-image-data">\n        <div class="rs-image-data__inf">\n            <div class="rs-image-data__label">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"label",a.autoesc),a.autoesc),h+='</div>\n            <div class="rs-image-data__name">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"name",a.autoesc),a.autoesc),h+='</div>\n        </div>\n        <div class="rs-image-data__select">\n            <input type="checkbox" class="rs-image-selection-checkbox" />\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.information.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<h2 class="rs-information__title">\n    Information\n</h2>\n<div class="rs-information__total">\n    <div>\n        Pictures <br />\n        <b>',h+=d.suppressValue(d.contextOrFrameLookup(b,c,"count"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Min resolution <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"minResolution"),a.autoesc),h+="</b>\n    </div>\n\n    <div>\n        Max resolution<br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"maxResolution"),a.autoesc),h+='</b>\n    </div>\n</div>\n<div class="rs-information__resolution">\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-single-image">\n    <div class="rs-canvas-place" id="rsSingleImage">\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.information.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<h2 class="rs-information__title">\n    Zoom\n</h2>\n<div class="rs-information__zoom">\n    <a href="#to-width" id="fitToWidth">Fit to width</a>\n    <a href="#source" id="sourceSize">Original size</a>\n\n    <div class="rs-information__zoom-value">\n        Actual zoom: <b id="zoomValue">100%</b>\n    </div>\n</div>\n\n<h2 class="rs-information__title">\n    Information\n</h2>\n<div class="rs-information__total">\n    <div>\n        Resolution <br />\n        <b>',h+=d.suppressValue(d.contextOrFrameLookup(b,c,"resolution"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Size <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"size"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Type <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"type"),a.autoesc),h+="</b>\n    </div>\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["toolbar.button.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div id="t-button__',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"name",a.autoesc),a.autoesc),h+='" class="rs-toolbar-button">\n    ',""!=d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc)?(h+='\n    <i class="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc),a.autoesc),h+='"></i>\n    '):(h+="\n        ",h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"localizedName",a.autoesc),a.autoesc),h+="\n    "),h+="\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}();var Core;!function(a){var b=function(){function a(a){this.current=-1,this.image=a,this.actions=[],this.actionsResult=[]}return a.prototype.process=function(a){return this.actions.splice(this.current+1),this.actions.push(a),this.current++,this.actionsResult.splice(this.current),this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)},a.prototype.undo=function(){if(this.current>=0){var a=this.actions[this.current];return this.current--,this.actionsResult.push(this.doAction(a.unExecute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.redo=function(){if(this.current<this.actions.length-1){this.current++;var a=this.actions[this.current];return this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.doAction=function(a,b){var c=this;return 0==this.actionsResult.length?a.apply(b):new Promise(function(d){_.last(c.actionsResult).then(function(){a.apply(b).then(function(a){d(a)})})})},a}();a.ActionDispatcher=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b,c){this.imageName=b,this.imageType=c,this.id="",this.actionDispatcher=null,this.imageBase64="",this.image=null,this.brightness=0,this.vibrance=0,this.hue=0,this.gamma=0,this.clip=0,this.stackBlur=0,this.contrast=0,this.saturation=0,this.exposure=0,this.sepia=0,this.noise=0,this.sharpen=0,this.actionDispatcher=new a.ActionDispatcher(this)}return b.prototype.create=function(a){var b=this;return this.imageBase64=a,new Promise(function(a){b.getImage().then(function(c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=c.width,d.height=c.height,e.drawImage(c,0,0),b.originalImage=e.getImageData(0,0,c.width,c.height),b.imageBase64=d.toDataURL(b.imageType,.8),d.width=1,d.height=1,b.init(),a(b)})})},b.prototype.init=function(){this.processedImage=this.originalImage,this.width=this.originalImage.width,this.height=this.originalImage.height,this.brightness=0},b.prototype.getOriginalCoordinates=function(a,b){return{x:this.originalImage.width*a/this.processedImage.width,y:this.originalImage.height*b/this.processedImage.height}},b.prototype.getOriginalImage=function(){return this.originalImage},b.prototype.replaceOriginal=function(a){this.originalImage=a},b.prototype.crop=function(a,b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d");e.width=this.originalImage.width,e.height=this.originalImage.height,f.putImageData(this.originalImage,0,0);var g=this.getOriginalCoordinates(a,b),h=this.getOriginalCoordinates(c,d);this.originalImage=f.getImageData(g.x,g.y,h.x,h.y),this.width=c,this.height=d},b.prototype.save=function(){var b=this,c=document.createElement("canvas"),d=c.getContext("2d");c.width=this.width,c.height=this.height,d.putImageData(this.originalImage,0,0),this.image=null;var e;return e=this.width!=this.originalImage.width||this.height!=this.originalImage.height?new a.ImageResizer(this.originalImage,this.width,this.height).resize():Promise.resolve(d.getImageData(0,0,this.width,this.height)),e.then(function(a){return c.width=a.width,c.height=a.height,d.putImageData(a,0,0),new Promise(function(e){var f=b;Caman(c,function(){var b=this;b.brightness(f.brightness),b.vibrance(f.vibrance),b.render(function(){e(d.getImageData(0,0,a.width,a.height))})})})}).then(function(a){return b.processedImage=a,c.width=b.processedImage.width,c.height=b.processedImage.height,d.putImageData(b.processedImage,0,0),b.imageBase64=c.toDataURL(b.imageType,.8),c.width=1,c.height=1,b.getImage(),b})},b.prototype.getSize=function(){return Math.round(atob(this.getImageBase64().substr(this.getImageBase64().indexOf(";base64")+8)).length/1e3)},b.prototype.getImageData=function(){return this.processedImage},b.prototype.getWidth=function(){return this.processedImage.width},b.prototype.getHeight=function(){return this.processedImage.height},b.prototype.getName=function(){return this.imageName},b.prototype.getLabel=function(){return""},b.prototype.getType=function(){return this.imageType},b.prototype.getImageBase64=function(){return this.imageBase64},b.prototype.getActionDispatcher=function(){return this.actionDispatcher},b.prototype.setId=function(a){this.id=a},b.prototype.getId=function(){return this.id},b.prototype.getImage=function(){var a=this;return null!=this.image?Promise.resolve(this.image):new Promise(function(b){var c=new Image;c.onload=function(){a.image=c,b(c)},c.src=a.imageBase64})},b}();a.RsImage=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a,b,c){this.original=a,this.newWidth=b,this.newHeight=c,this.size=this.original.data.length}return a.prototype.resize=function(){return this.picaResize()},a.prototype.picaResize=function(a){var b=this;return void 0===a&&(a=3),new Promise(function(c){pica.resizeBuffer({src:b.original.data,width:b.original.width,height:b.original.height,toWidth:b.newWidth,toHeight:b.newHeight,alpha:!0,quality:a},function(a,d){for(var e=document.createElement("canvas"),f=e.getContext("2d"),g=f.createImageData(b.newWidth,b.newHeight),h=0;h<d.length;h++)g.data[h]=d[h];e.width=1,e.height=1,c(g)})})},a}();a.ImageResizer=b}(Core||(Core={}));var Modules;!function(a){var b=function(){function a(a,b){this.image=a,this.brightness=b}return a.prototype.execute=function(){return this.oldBrightness=this.image.brightness,this.image.brightness=this.brightness,this.image.save()},a.prototype.unExecute=function(){return this.image.brightness=this.oldBrightness,this.image.save()},a}();a.BrightnessAction=b}(Modules||(Modules={}));var Core;!function(a){!function(a){a[a.ACTION=0]="ACTION",a[a.DELEGATE=1]="DELEGATE",a[a.GROUP=2]="GROUP"}(a.ModuleType||(a.ModuleType={}));a.ModuleType}(Core||(Core={}));var Core;!function(a){var b=function(){function b(){this.images={},this.collections=[]}return b.prototype.newCollection=function(b){var c=new a.ImageCollection(this);for(var d in b)c.add(d);return this.collections.push(c),c},b.prototype.tryAdd=function(a){if(""==a.getId()){for(var b=Math.random().toString(36).substring(7);_.has(this.images,b);)b=Math.random().toString(36).substring(7);a.setId(b),this.add(a)}},b.prototype.add=function(a){this.images[a.getId()]=a},b.prototype.has=function(a){return _.has(this.images,a.getId())},b.prototype.remove=function(){},b}();a.ImageManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a){this.manager=a,this.images=[]}return a.prototype.add=function(a){this.manager.tryAdd(a),this.images.push(a)},a.prototype.has=function(a){return this.images.indexOf(a)>-1},a.prototype.remove=function(a){var b=this.images.indexOf(a);b>-1&&this.images.splice(b,1)},a.prototype.getResolutionStats=function(){var a={width:this.images[0].width,height:this.images[0].height},b={width:0,height:0};return this.images.forEach(function(c){c.width*c.height<a.width*a.height&&(a.width=c.width,a.height=c.height),c.width*c.height>b.width*b.height&&(b.width=c.width,b.height=c.height)}),{min:a,max:b}},a.prototype.count=function(){return this.images.length},a.prototype.getImages=function(){return this.images},a.prototype.getImage=function(b){var c=new a(this.manager);return this.images.forEach(function(a){a.getId()==b&&c.add(a)}),c},a.prototype.findImage=function(a){var b=[];return this.images.forEach(function(c){_.contains(a,c.getId())&&b.push(c)}),b},a}();a.ImageCollection=b}(Core||(Core={}));var UI;!function(a){var b;!function(a){a[a.WIDTH=0]="WIDTH",a[a.HEIGHT=1]="HEIGHT",a[a.SOURCE=2]="SOURCE"}(b||(b={}));var c=function(){function a(a,b){this.page=a,this.image=b,this.canvas=null,this.scale=1,this.scale=1}return a.prototype.type=function(){return 0},a.prototype.render=function(){var a=this;this.page.getImagePlace().html(nunjucks.render("single.image.html.njs",{})),this.getCanvas(),this.renderImage(),this.setScale(this.scale),$("#fitToWidth").click(function(){return a.setZoom(0),!1}),$("#sourceSize").click(function(){return a.setZoom(2),!1})},a.prototype.setZoom=function(a){var b=this.page.getImagePlace().find(".rs-single-image"),c=b.find("canvas"),d=1;0==a?(d=b.width()/c.width(),b.css("overflow","hidden")):2==a&&b.css("overflow","scroll"),this.setScale(d)},a.prototype.setScale=function(a){var b=this.page.getImagePlace().find(".rs-single-image"),c=b.find("canvas");b.scrollLeft(0),b.scrollTop(0),c.css("transform-origin","0 0"),c.css("transform","scale("+a+")"),this.scale=a,$("#zoomValue").text(Math.floor(100*a)+"%")},a.prototype.getScale=function(){return this.scale},a.prototype.selected=function(){return[this.image]},a.prototype.getAreaElement=function(){return this.page.getImagePlace().find("#rsSingleImage")},a.prototype.getInformation=function(){return nunjucks.render("single.information.html.njs",{resolution:this.image.width+"x"+this.image.height,size:this.image.getSize()+" kb",type:this.image.getType()})},a.prototype.renderImage=function(){this.context.putImageData(this.image.getImageData(),0,0)},a.prototype.getCanvas=function(){var a=this.page.getImagePlace().find("#"+this.image.getId());0==a.length&&this.page.getImagePlace().find("#rsSingleImage").html('<canvas id="'+this.image.getId()+'"></canvas>'),this.canvas=this.page.getImagePlace().find("#"+this.image.getId())[0],this.canvas.width=this.image.getWidth(),this.canvas.height=this.image.getHeight(),this.context=this.canvas.getContext("2d")},a}();a.SingleView=c}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.imageCollection=b}return a.prototype.type=function(){return 1},a.prototype.render=function(){var a=this;this.page.getImagePlace().html("");var b=this.imageCollection.getImages();if(b.length>0)var c=0,d=setInterval(function(){a.renderImage(b[c]),c++,c==b.length&&clearInterval(d)},10)},a.prototype.getInformation=function(){if(this.imageCollection.count()>0){var a=this.imageCollection.getResolutionStats();return nunjucks.render("grid.information.html.njs",{count:this.imageCollection.count(),minResolution:a.min.width+"x"+a.min.height,maxResolution:a.max.width+"x"+a.max.height})}return""},a.prototype.selected=function(){var a=[];return this.page.getImagePlace().find(".rs-image-selected").each(function(b,c){a.push($(c).data("id"))}),this.imageCollection.findImage(a)},a.prototype.renderImage=function(a){var b=this;a.getImage().then(function(c){var d=$(nunjucks.render("grid.image.html.njs",{image:{src:c,name:a.getName(),id:a.getId(),label:a.getLabel()}}));d.find(".rs-image-block")[0].appendChild(c),b.page.getImagePlace().append(d)})},a}();a.GridView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.editor=b,this.$toolbar=this.editor.UI().getToolbarPlace()}return a.prototype.render=function(){this.$toolbar.html(""),null!==this.page.getParent()&&this.renderBackButton(this.$toolbar),this.renderCommonButton(this.$toolbar)},a.prototype.renderModuleToolbar=function(a,b){var c=this,d=this.editor.getModuleManager().getModules(this.editor.UI().getType(),null);d.forEach(function(a){var d=$(nunjucks.render("toolbar.button.html.njs",{button:{name:a.name(),icon:a.icon(),localizedName:a.name()}}));b.append(d),c.editor.UI().initModule(d,a)})},a.prototype.renderCommonButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"upload",icon:"fa fa-upload",localizedName:"upload"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"undo",icon:"fa fa-undo",localizedName:"undo"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"redo",icon:"fa fa-repeat",localizedName:"redo"}})))},a.prototype.renderBackButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"back",icon:"fa fa-arrow-left",localizedName:"back"}})))},a}();a.Toolbar=b}(UI||(UI={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(1,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.GridToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(0,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.SingleToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){void 0===c&&(c=null),this.editor=a,this.imageCollection=b,this.parent=c,this.view=null}return b.prototype.hasParent=function(){return null!=this.parent},b.prototype.getParent=function(){return this.parent},b.prototype.appendImage=function(b){this.imageCollection.add(b),1==this.imageCollection.count()?1==this.view.type()&&(this.view=null,this.view=new a.SingleView(this,this.imageCollection.getImages()[0])):0==this.view.type()&&(this.view=null,this.view=new a.GridView(this,this.imageCollection))},b.prototype.getView=function(){return null!=this.view?this.view:(this.view=1==this.imageCollection.getImages().length?new a.SingleView(this,this.imageCollection.getImages()[0]):new a.GridView(this,this.imageCollection),this.view)},b.prototype.getToolbar=function(){return 1==this.imageCollection.getImages().length?new a.SingleToolbar(this,this.editor.getEditor()):new a.GridToolbar(this,this.editor.getEditor())},b.prototype.render=function(){this.getToolbar().render(),this.getImagePlace().html("");var a=this.getView().getInformation();""!=a?(this.getInformationPlace().parent().show(),this.getInformationPlace().html(a)):this.getInformationPlace().parent().hide(),this.getView().render()},b.prototype.getImagePlace=function(){return this.editor.getImagePlace()},b.prototype.getInformationPlace=function(){return this.editor.getInformationPlace()},b}();a.Page=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(){}return a.init=function(a,b,c){return 0==b.type()?this.initAction(a,b,c):1==b.type()?this.initDelegate(a,b,c):alert("GROUP!!!"),b},a.initAction=function(){},a.initDelegate=function(a,b,c){var d=this;a.click(function(){$(".rs-toolbar-button").removeClass("active"),a.addClass("active"),d.renderModule(b,c)})},a.renderModule=function(a,b){return null!=b.UI().getActiveModule()&&b.UI().getActiveModule().deinit(),a.init(b.UI().showPopover(a.html())),b.UI().setActiveModule(a),!1},a}();a.ModuleInitialization=b}(UI||(UI={}));var UI;!function(a){var b;!function(a){var b=function(){function a(){this.events={}}return a.prototype.on=function(a,b,c){void 0===c&&(c="_"),_.has(this.events,a)||(this.events[a]={}),_.has(this.events[a],c)||(this.events[a][c]=[]),this.events[a][c].push(b)},a.prototype.off=function(a){var b=this;void 0===a&&(a="_"),_.map(this.events,function(c,d){b.events[d]=_.omit(c,a)})},a.prototype.trigger=function(a,b){var c=this;void 0===b&&(b=null),_.has(this.events,a)&&_.map(this.events[a],function(a){a.forEach(function(a){a({data:b,widget:c})})})},a}();a.RsWidget=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b){a.call(this),this.$el=b,this.$label=$('<div class="rs-progress-label"></div>'),this.$line=$('<div class="rs-progress-line"></div>'),this.$el.html(""),this.$el.append(this.$label),this.$el.append(this.$line)}return __extends(b,a),b.prototype.getOpCount=function(){return this.opCount},b.prototype.start=function(a,b){this.opCount=b,this.setProgress(0,a),this.trigger("start"),this.$el.show()},b.prototype.setProgress=function(a,b){this.$label.text(b),this.$line.css("width",a/this.opCount*100+"%"),a>=this.opCount?this.trigger("stop"):this.trigger("progress",a)},b.prototype.stop=function(a){var b=this;this.$label.text(a),setTimeout(function(){b.$el.hide()},200)},b}(a.RsWidget);a.RsProgressBar=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var UI;!function(a){var b=function(){function b(b,c,d){var e=this;this.$el=b,this.editor=c,this.images=d,this.pages=[],this.page=null,this.activeModule=null,this.$el.html(nunjucks.render("editor.html.njs",{}));var f=this.$el.find("#rsFileInput");f.on("change",function(){c.getLoader().load(this.files)}),this.$el.on("click","#t-button__upload",function(){return f.trigger("click"),!1}),this.$el.on("click",".rs-image-block, .rs-image-data__inf",function(a){e.editImage($(a.target).closest(".rs-image").data("id"))}),this.$el.on("click","#t-button__back",function(){return e.back(),!1}),this.$el.on("click",".rs-image-selection-checkbox",function(a){e.selectImage($(a.target).closest(".rs-image"))}),this.$toolbarPlace=this.$el.find("#rsToolbarPlace"),this.$popOver=this.$el.find("#rsPopover"),this.$imagePlace=this.$el.find("#rsImagePlace"),this.$informationPlace=this.$el.find("#rsInformation"),this.progressBar=new a.Widgets.RsProgressBar(this.$el.find("#rsProgressBar")),this.progressBar.on("stop",function(){e.progressBar.stop("Loading complete!")})}return b.prototype.showLoader=function(a){this.progressBar.start("Loading image...",a)},b.prototype.progressLoader=function(a){this.progressBar.setProgress(a,"Image "+a+" from "+this.progressBar.getOpCount())},b.prototype.initModule=function(b,c){a.ModuleInitialization.init(b,c,this.editor)},b.prototype.getActiveModule=function(){return this.activeModule},b.prototype.setActiveModule=function(a){this.activeModule=a},b.prototype.initToolbar=function(a){var b=this;null!=this.activeModule&&a.find("#t-button__"+this.activeModule.name()).addClass("active"),a.find("#t-button__redo").click(function(){return b.redo(),!1}),a.find("#t-button__undo").click(function(){return b.undo(),!1})},b.prototype.getView=function(){return this.getPage().getView()},b.prototype.redo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().redo())}),Promise.all(b).then(function(){a.render()})},b.prototype.undo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().undo())}),Promise.all(b).then(function(){a.render()})},b.prototype.showPopover=function(a){return this.$popOver.html(a),this.$popOver.show(),this.$popOver},b.prototype.clearPopover=function(){this.$popOver.html(""),this.$popOver.hide()},b.prototype.back=function(){this.page.hasParent()&&(this.page=this.page.getParent(),this.render())},b.prototype.getImagePlace=function(){return this.$imagePlace},b.prototype.getToolbarPlace=function(){return this.$toolbarPlace},b.prototype.getInformationPlace=function(){return this.$informationPlace},b.prototype.selected=function(){return this.getPage().getView().selected()},b.prototype.getEditor=function(){return this.editor},b.prototype.getPage=function(){return null==this.page&&(this.page=new a.Page(this,this.images),this.pages.push(this.page)),this.page},b.prototype.getType=function(){return this.getPage().getView().type()},b.prototype.render=function(){null!=this.activeModule&&this.activeModule.deinit(),this.getPage().render(),null!=this.activeModule&&(this.activeModule.viewType()==this.getType()||2==this.activeModule.viewType())&&a.ModuleInitialization.renderModule(this.activeModule,this.editor)},b.prototype.appendImage=function(a){this.pages.forEach(function(b){b.appendImage(a)})},b.prototype.editImage=function(b){var c=this.images.getImage(b);this.page=new a.Page(this,c,this.page),this.pages.push(this.page),this.render()},b.prototype.selectImage=function(a){a.hasClass("rs-image-selected")?a.removeClass("rs-image-selected"):a.addClass("rs-image-selected")},b}();a.Editor=b}(UI||(UI={}));var Core;!function(a){!function(a){a[a.SINGLE=0]="SINGLE",a[a.GRID=1]="GRID",a[a.ANY=2]="ANY"}(a.ModuleViewType||(a.ModuleViewType={}));var b=(a.ModuleViewType,function(){function a(a){this.editor=a,this.modules={},this.registerModule("resize",new Modules.ResizeModule(this.editor),0),this.registerModule("color",new Modules.ColorModule(this.editor),2),this.registerModule("crop",new Modules.CropModule(this.editor),0)}return a.prototype.registerModule=function(a,b,c){a in this.modules||(this.modules[a]={module:b,type:c})},a.prototype.getModule=function(a){if(a in this.modules)return this.modules[a].module;throw new Error("Invalid module name")},a.prototype.getModules=function(a,b){return void 0===a&&(a=2),void 0===b&&(b=null),_.map(_.filter(this.modules,function(c){return c.type!=a&&2!=a&&2!=c.type||c.module.parent()!=b?!1:!0}),function(a){return a.module})},a}());a.ModuleManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(a){this.editor=a,this.total=0,this.total=0}return b.prototype.load=function(a){var b=this,c=0;this.total=0,this.editor.UI().showLoader(a.length);var d=new Promise(function(d){var e=setInterval(function(){if(c<a.length){var f=!1;c==a.length-1&&(f=!0),b.loadFile(a[c],d,f),c++}else clearInterval(e)},100)});d.then(function(){b.editor.UI().render()})},b.prototype.loadFile=function(b,c,d){var e=this;if(!b.type.match(/image.*/))return!1;var f=new FileReader;f.onload=function(f){var g=new a.RsImage(b.name,b.type);g.create(f.target.result).then(function(a){e.editor.appendImage(a),e.total++,e.editor.UI().progressLoader(e.total),d&&c(1)})},f.readAsDataURL(b)},b}();a.ImageLoader=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b){this.imageManager=new a.ImageManager,this.ui=new UI.Editor(b,this,this.imageManager.newCollection([])),this.moduleManager=new a.ModuleManager(this),this.loader=new a.ImageLoader(this),this.ui.render()}return b.prototype.UI=function(){return this.ui},b.prototype.getModuleManager=function(){return this.moduleManager},b.prototype.appendImage=function(a){this.ui.appendImage(a)},b.prototype.getLoader=function(){return this.loader},b.prototype.getImageManager=function(){return this.imageManager},b}();a.RsImageEditor=b}(Core||(Core={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f){var g=this;void 0===e&&(e=1),void 0===f&&(f=0),a.call(this),this.$el=b,this.min=c,this.max=d,this.step=e,this.start=f,this.$slider=$('<div class="rs-slider-handle"></div>'),this.$el.html(""),this.$el.addClass("rs-slider"),this.$el.append(this.$slider),this.$slider.css("left",this.getPixelPos(this.start)+"px");var h=$(document);this.$slider.mousedown(function(a){var b=a.clientX-parseInt(g.$slider.css("left"));h.off(".RsSlider"),h.on("mousemove.RsSlider",function(a){var c=a.clientX-b;0>c&&(c=0);var d=g.$el.width()-g.$slider.width();c>d&&(c=d),g.$slider.css("left",c+"px"),g.trigger("move",g.getVal(c))}),h.on("mouseup.RsSlider",function(){var a=parseInt(g.$slider.css("left"));g.trigger("stopmove",g.getVal(a)),h.off(".RsSlider")})}),this.on("move",function(a){g.$slider.text(a.data)}),this.trigger("move",this.start)}return __extends(b,a),b.prototype.getVal=function(a){return Math.round(a*((this.max-this.min)/this.step)/(this.$el.width()-this.$slider.width()))*this.step+this.min},b.prototype.getPixelPos=function(a){return(a-this.min)/this.step*(this.$el.width()-this.$slider.width())/((this.max-this.min)/this.step)},b}(a.RsWidget);a.RsSlider=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.html=function(){return nunjucks.render("color.dialog.html.njs",{})},b.prototype.viewType=function(){return 2},b.prototype.init=function(b){var c=this,d=0,e=0;if(0==this.editor.UI().getType()){var f=this.editor.UI().selected()[0];d=f.brightness,e=f.vibrance}new UI.Widgets.RsSlider(b.find("#brightnessSlider"),-100,100,1,d).on("stopmove",function(b){c.doAction(a.BrightnessAction,b.data)}),new UI.Widgets.RsSlider(b.find("#vibranceSlider"),-200,200,5,e).on("stopmove",function(b){c.doAction(a.VibranceAction,b.data)})},b.prototype.deinit=function(){this.editor.UI().clearPopover()},b.prototype.icon=function(){return"fa fa-image"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"color"},b.prototype.doAction=function(a,b){var c=this,d=[];this.editor.UI().selected().forEach(function(c){var e=new a(c,b);d.push(c.getActionDispatcher().process(e))}),Promise.all(d).then(function(){c.editor.UI().render()})},b}();a.ColorModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b){this.image=a,this.value=b}return a.prototype.execute=function(){return this.oldValue=this.image.vibrance,this.image.vibrance=this.value,this.image.save()},a.prototype.unExecute=function(){return this.image.vibrance=this.oldValue,this.image.save()},a}();a.VibranceAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c,d,e){this.image=a,this.left=b,this.top=c,this.width=d,this.height=e}return a.prototype.execute=function(){return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.originalImage=this.image.getOriginalImage(),this.image.crop(this.left,this.top,this.width,this.height),this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.replaceOriginal(this.originalImage),this.image.save()},a}();a.CropAction=b}(Modules||(Modules={}));var UI;!function(a){var b;!function(a){var b=function(a){
function b(b,c,d){a.call(this),this.$el=b,this.$parent=c,this.index=d,this.itemHalfSize=5,this.init()}return __extends(b,a),b.prototype.getElementCorners=function(){var a={x:this.$el.position().left,y:this.$el.position().top},b={x:a.x+this.$el.width(),y:a.y},c={x:a.x+this.$el.width(),y:a.y+this.$el.height()},d={x:a.x,y:a.y+this.$el.height()};return{topLeft:a,topRight:b,bottomRight:c,bottomLeft:d}},b.prototype.getPosition=function(){return this.position},b.prototype.getIndex=function(){return this.index},b.prototype.toPlace=function(){var a,b=this.getElementCorners();0==this.index?a=b.topLeft:1==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.topRight.y}:2==this.index?a=b.topRight:3==this.index?a={x:b.topRight.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}:4==this.index?a=b.bottomRight:5==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.bottomRight.y}:6==this.index?a=b.bottomLeft:7==this.index&&(a={x:b.topLeft.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}),this.position=a,this.$item.css({left:a.x-this.itemHalfSize+"px",top:a.y-this.itemHalfSize+"px"})},b.prototype.init=function(){var a=this;this.$item=$('<div class="rs-resizable-item item_'+this.index+'"></div>'),this.$parent.append(this.$item),this.toPlace();var b=$(document);this.$item.mousedown(function(c){var d=c.clientX-parseInt(a.$item.css("left"))-a.itemHalfSize,e=c.clientY-parseInt(a.$item.css("top"))-a.itemHalfSize;b.on("mousemove.RsResize_"+a.index,function(b){var c={x:b.clientX-d,y:b.clientY-e};a.moveItem(c),a.trigger("move",{index:a.index,newPosition:a.position,oldPosition:{x:d,y:e}})}),b.on("mouseup.RsResize_"+a.index,function(){b.off(".RsResize_"+a.index)})})},b.prototype.moveItem=function(a){var b=this.getElementCorners();(0==this.index||7==this.index||6==this.index)&&a.x>=b.topRight.x-10&&(a.x=b.topRight.x-10),(0==this.index||1==this.index||2==this.index)&&a.y>=b.bottomRight.y-10&&(a.y=b.bottomRight.y-10),this.$item.css(1==this.index||5==this.index?{top:a.y-5+"px"}:7==this.index||3==this.index?{left:a.x-5+"px"}:{left:a.x-5+"px",top:a.y-5+"px"}),this.position={x:parseInt(this.$item.css("left"))+5,y:parseInt(this.$item.css("top"))+5}},b}(a.RsWidget),c=function(a){function c(c,d){var e=this;a.call(this),this.$el=c,this.$parent=d,this.items=[],this.$el.addClass("rs-resizable");for(var f=0;8>f;f++){var g=new b(this.$el,this.$parent,f);this.items.push(g),g.on("move",function(a){e.onItemMove(a.data.index,a.data.newPosition,a.data.oldPosition)})}var h=$(document);this.$el.mousedown(function(a){var b=a.clientX-parseInt(e.$el.css("left")),c=a.clientY-parseInt(e.$el.css("top"));h.on("mousemove.RsResize",function(a){var d={x:a.clientX-b,y:a.clientY-c};e.$el.css({left:d.x,top:d.y}),e.updateItems()}),h.on("mouseup.RsResize",function(){h.off(".RsResize")})})}return __extends(c,a),c.prototype.onItemMove=function(a,b){0==a?(this.$el.css({left:b.x+"px",top:b.y+"px",width:this.items[4].getPosition().x-b.x+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):1==a?(this.$el.css({top:b.y+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):2==a?(this.$el.css({right:b.x+"px",top:b.y+"px",width:b.x-this.items[6].getPosition().x+"px",height:this.items[6].getPosition().y-b.y+"px"}),this.updateItems([6])):3==a?(this.$el.css({right:b.x+"px",width:b.x-this.items[6].getPosition().x+"px"}),this.updateItems([6])):4==a?(this.$el.css({right:b.x+"px",bottom:b.y+"px",width:b.x-this.items[0].getPosition().x+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):5==a?(this.$el.css({bottom:b.y+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):6==a?(this.$el.css({left:b.x+"px",bottom:b.y+"px",width:this.items[2].getPosition().x-b.x+"px",height:b.y-this.items[2].getPosition().y+"px"}),this.updateItems([2])):7==a&&(this.$el.css({left:b.x+"px",width:this.items[2].getPosition().x-b.x+"px"}),this.updateItems([2]))},c.prototype.getBounds=function(){return{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}},c.prototype.updateItems=function(a){void 0===a&&(a=[]),this.trigger("resize",{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}),this.items.forEach(function(b){_.contains(a,b.getIndex())||b.toPlace()})},c}(a.RsWidget);a.RsResizable=c}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.view=null}return b.prototype.html=function(){return nunjucks.render("crop.dialog.html.njs",{})},b.prototype.deinit=function(){this.editor.UI().clearPopover(),null!=this.view&&(this.$cropRect.remove(),this.view.getAreaElement().find(".rs-resizable-item").remove())},b.prototype.viewType=function(){return 0},b.prototype.init=function(){var a=this;this.view=this.editor.UI().getView(),this.$cropRect=$('<div class="crop-rect"></div>'),this.view.getAreaElement().append(this.$cropRect),this.cropResizableWidget=new UI.Widgets.RsResizable(this.$cropRect,this.view.getAreaElement()),$("#crop_ok").click(function(){var b=a.cropResizableWidget.getBounds(),c=Math.round(b.width/a.view.getScale());a.doAction(b.left/a.view.getScale(),b.top/a.view.getScale(),c,b.height/a.view.getScale())})},b.prototype.icon=function(){return"fa fa-crop"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"crop"},b.prototype.doAction=function(b,c,d,e){var f=this,g=[];this.editor.UI().selected().forEach(function(f){var h=new a.CropAction(f,b,c,d,e);g.push(f.getActionDispatcher().process(h))}),Promise.all(g).then(function(){f.editor.UI().render()})},b}();a.CropModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c){this.image=a,this.width=b,this.height=c}return a.prototype.execute=function(){return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.image.width=this.width,this.image.height=this.height,this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.save()},a}();a.ResizeAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.isLocked=!0,this.image=null}return b.prototype.html=function(){return nunjucks.render("resize-single.dialog.html.njs",{isLocked:this.isLocked})},b.prototype.deinit=function(){this.editor.UI().clearPopover()},b.prototype.viewType=function(){return 0},b.prototype.init=function(a){var b=this;this.image=this.editor.UI().selected()[0],this.$widthInput=a.find(".m__single-resize__val.width input"),this.$heightInput=a.find(".m__single-resize__val.height input"),this.$lock=a.find(".m__single-resize__lock"),this.$widthInput.val(this.image.width.toString()),this.$heightInput.val(this.image.height.toString());var c=_.debounce(function(){b.doAction(b.$widthInput.val(),b.$heightInput.val())},500);this.$lock.click(function(){b.isLocked?(b.isLocked=!1,b.$lock.find("i").attr("class","fa fa-unlock")):(b.isLocked=!0,b.update(b.image),c(),b.$lock.find("i").attr("class","fa fa-lock"))}),this.$widthInput.on("input",function(){var a=parseInt(b.$widthInput.val());if(!isNaN(a)&&a>=50){b.isLocked&&b.$heightInput.val(Math.round(b.image.getOriginalImage().height*a/b.image.getOriginalImage().width)+"");var d=parseInt(b.$heightInput.val());!isNaN(d)&&d>=30&&c()}}),this.$heightInput.on("input",function(){var a=parseInt(b.$heightInput.val());if(!isNaN(a)&&a>=30){b.isLocked&&b.$widthInput.val(Math.round(b.image.getOriginalImage().width*a/b.image.getOriginalImage().height)+"");var d=parseInt(b.$widthInput.val());!isNaN(d)&&d>=50&&c()}})},b.prototype.update=function(a){var b=parseInt(this.$widthInput.val()),c=parseInt(this.$heightInput.val());!isNaN(b)&&!isNaN(c)&&b>=50&&c>=30&&(b>c?this.$heightInput.val(Math.round(a.getOriginalImage().height*b/a.getOriginalImage().width)+""):this.$widthInput.val(Math.round(a.getOriginalImage().width*c/a.getOriginalImage().height)+""))},b.prototype.icon=function(){return"fa fa-expand"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"resize"},b.prototype.doAction=function(b,c){var d=this,e=new a.ResizeAction(this.image,b,c);this.image.getActionDispatcher().process(e).then(function(){d.editor.UI().render()})},b}();a.ResizeModule=b}(Modules||(Modules={}));