!function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <input class="m_resize-width" type="text" placeholder="width" value="150" /> <br />\n    <input class="m_resize-height" type="text" placeholder="height"value="100" /> <br /> <br />\n\n    <button class="m_resize-ok" value="ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["editor.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-editor-block">\n    <input type="file" id="rsFileInput" style="display: none" multiple />\n    <div id="rsToolbarPlace" class="rs-toolbar"></div>\n    <div class="rs-content">\n        <div id="rsImagePlace" class="rs-image-place"></div>\n        <div id="rsPopover" class="rs-popover hide"></div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-image" data-id="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"id",a.autoesc),a.autoesc),h+='">\n    <div class="rs-image-block">\n        <img src="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='" />\n    </div>\n    <div class="rs-image-data">\n        <div class="rs-image-data__inf">\n            <div class="rs-image-data__label">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"label",a.autoesc),a.autoesc),h+='</div>\n            <div class="rs-image-data__name">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"name",a.autoesc),a.autoesc),h+='</div>\n        </div>\n        <div class="rs-image-data__select">\n            <input type="checkbox" class="rs-image-selection-checkbox" />\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-single-image" id="rsSingleImage">\n\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["toolbar.button.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div id="t-button__',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"name",a.autoesc),a.autoesc),h+='" class="rs-toolbar-button">\n    ',""!=d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc)?(h+='\n    <i class="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc),a.autoesc),h+='"></i>\n    '):(h+="\n        ",h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"localizedName",a.autoesc),a.autoesc),h+="\n    "),h+="\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}();var Core;!function(a){var b=function(){function a(a){this.current=-1,this.image=a,this.actions=[],this.actionsResult=[]}return a.prototype.process=function(a){return this.actions=this.actions.splice(this.current),this.actions.push(a),this.current++,this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)},a.prototype.undo=function(){if(this.current>=0){var a=this.actions[this.current];return this.current--,this.actionsResult.push(this.doAction(a.unExecute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.redo=function(){if(this.current<this.actions.length-1){this.current++;var a=this.actions[this.current];return this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.doAction=function(a,b){var c=this;return 0==this.actionsResult.length?a.apply(b):new Promise(function(d){_.last(c.actionsResult).then(function(){a.apply(b).then(function(a){d(a)})})})},a}();a.ActionDispatcher=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b,c){this.imageName=b,this.imageType=c,this.id="",this.actionDispatcher=null,this.imageBase64="",this.actionDispatcher=new a.ActionDispatcher(this)}return b.prototype.create=function(a){var b=this;return this.imageBase64=a,new Promise(function(a){b.getImage().then(function(c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=c.width,d.height=c.height,e.drawImage(c,0,0),b.imageData=e.getImageData(0,0,c.width,c.height),a(b)})})},b.prototype.update=function(a,b){this.imageBase64=b,this.imageData=a},b.prototype.getActionDispatcher=function(){return this.actionDispatcher},b.prototype.setId=function(a){this.id=a},b.prototype.getId=function(){return this.id},b.prototype.getImageData=function(){return this.imageData},b.prototype.getImageBase64=function(){return this.imageBase64},b.prototype.getWidth=function(){return this.imageData.width},b.prototype.getHeight=function(){return this.imageData.height},b.prototype.getName=function(){return this.imageName},b.prototype.getLabel=function(){return""},b.prototype.getImage=function(){var a=this;return new Promise(function(b){var c=new Image;c.onload=function(){b(c)},c.src=a.imageBase64})},b}();a.RsImage=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a,b,c,d){this.r=a,this.g=b,this.b=c,this.a=d}return a.prototype.devig=function(a){return this.r/=a,this.g/=a,this.b/=a,this.a/=a,this},a}(),c=function(){function a(a,b,c){this.original=a,this.newWidth=b,this.newHeight=c,this.size=this.original.data.length}return a.prototype.resize=function(){var a=this.getWidthGridSize(),b=this.getHeightGridSize();return a>2&&b>2?Promise.resolve(this.downScaleSuperSampling(a,b)):this.upScale()},a.prototype.upScale=function(){var a=this,b=document.createElement("canvas"),c=b.getContext("2d");b.width=this.original.width,b.height=this.original.height,c.putImageData(this.original,0,0);var d=new Image;return new Promise(function(e){d.onload=function(){b.width=a.newWidth,b.height=a.newHeight,c.drawImage(d,0,0,a.newWidth,a.newHeight),e(c.getImageData(0,0,a.newWidth,a.newHeight))},d.src=b.toDataURL()})},a.prototype.downScaleSuperSampling=function(a,b){for(var c=document.createElement("canvas"),d=c.getContext("2d"),e=d.createImageData(this.newWidth,this.newHeight),f=this.cutImageData(a,b),g=0,h=0;h<this.newHeight;h++)for(var i=0;i<this.newWidth;i++){var j=f[h][i];j&&(e.data[g]=j.r,e.data[g+1]=j.g,e.data[g+2]=j.b,e.data[g+3]=j.a,g+=4)}return e},a.prototype.cutImageData=function(a,c){for(var d=0,e=[],f=0;f<this.original.height;f+=c){e[d]=[];for(var g=0;g<this.original.width;g+=a){for(var h=new b(0,0,0,0),i=0,j=f;f+c>j;j++)for(var k=g;g+a>k;k++){var l=4*(j*this.original.width+k);l+3<this.size&&(h.r=h.r+this.original.data[l],h.g=h.g+this.original.data[l+1],h.b=h.b+this.original.data[l+2],h.a=h.a+this.original.data[l+3],i++)}e[d].push(h.devig(i))}d++}return e},a.prototype.getWidthGridSize=function(){return Math.floor(this.original.width/this.newWidth)},a.prototype.getHeightGridSize=function(){return Math.floor(this.original.height/this.newHeight)},a}();a.ImageResizer=c}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a){this.image=a,this.saveOldImage()}return a.prototype.drawTempImage=function(){var a=document.createElement("canvas"),b=a.getContext("2d");return a.width=this.image.getWidth(),a.height=this.image.getHeight(),b.putImageData(this.image.getImageData(),0,0),{canvas:a,context:b}},a.prototype.saveOldImage=function(){this.oldImage={data:this.image.getImageData(),base64:this.image.getImageBase64()}},a.prototype.execute=function(){return Promise.resolve(this.image)},a.prototype.unExecute=function(){return this.image.update(this.oldImage.data,this.oldImage.base64),Promise.resolve(this.image)},a}();a.AbstractAction=b}(Core||(Core={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Modules;!function(a){var b=function(a){function b(b,c,d){a.call(this,b),this.width=c,this.height=d,this.image=b}return __extends(b,a),b.prototype.execute=function(){var a=this;this.saveOldImage();var b=this.drawTempImage();return new Core.ImageResizer(b.context.getImageData(0,0,b.canvas.width,b.canvas.height),this.width,this.height).resize().then(function(c){return b.canvas.width=a.width,b.canvas.height=a.height,b.context.putImageData(c,0,0),a.image.update(c,b.canvas.toDataURL()),a.image})},b}(Core.AbstractAction);a.ResizeAction=b}(Modules||(Modules={}));var Core;!function(a){!function(a){a[a.ACTION=0]="ACTION",a[a.DELEGATE=1]="DELEGATE",a[a.GROUP=2]="GROUP"}(a.ModuleType||(a.ModuleType={}));a.ModuleType}(Core||(Core={}));var Core;!function(a){var b=function(){function b(){this.images={},this.collections=[]}return b.prototype.newCollection=function(b){var c=new a.ImageCollection(this);for(var d in b)c.add(d);return this.collections.push(c),c},b.prototype.tryAdd=function(a){if(""==a.getId()){for(var b=Math.random().toString(36).substring(7);_.has(this.images,b);)b=Math.random().toString(36).substring(7);a.setId(b),this.add(a)}},b.prototype.add=function(a){this.images[a.getId()]=a},b.prototype.has=function(a){return _.has(this.images,a.getId())},b.prototype.remove=function(){},b}();a.ImageManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a){this.manager=a,this.images=[]}return a.prototype.add=function(a){this.manager.tryAdd(a),this.images.push(a)},a.prototype.has=function(a){return this.images.indexOf(a)>-1},a.prototype.remove=function(a){var b=this.images.indexOf(a);b>-1&&this.images.splice(b,1)},a.prototype.getImages=function(){return this.images},a.prototype.getImage=function(b){var c=new a(this.manager);return this.images.forEach(function(a){a.getId()==b&&c.add(a)}),c},a.prototype.findImage=function(a){var b=[];return this.images.forEach(function(c){_.contains(a,c.getId())&&b.push(c)}),b},a}();a.ImageCollection=b}(Core||(Core={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.image=b,this.canvas=null}return a.prototype.type=function(){return 0},a.prototype.render=function(){this.page.getImagePlace().html(nunjucks.render("single.image.html.njs",{})),this.getCanvas(),this.renderImage()},a.prototype.selected=function(){return[this.image]},a.prototype.renderImage=function(){this.context.putImageData(this.image.getImageData(),0,0)},a.prototype.getCanvas=function(){var a=this.page.getImagePlace().find("#"+this.image.getId());0==a.length&&this.page.getImagePlace().find("#rsSingleImage").html('<canvas id="'+this.image.getId()+'"></canvas>'),this.canvas=this.page.getImagePlace().find("#"+this.image.getId())[0],this.canvas.width=this.image.getWidth(),this.canvas.height=this.image.getHeight(),this.context=this.canvas.getContext("2d")},a}();a.SingleView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.imageCollection=b}return a.prototype.type=function(){return 1},a.prototype.render=function(){var a=this;this.page.getImagePlace().html(""),this.imageCollection.getImages().forEach(function(b){a.renderImage(b)})},a.prototype.selected=function(){var a=[];return this.page.getImagePlace().find(".rs-image-selected").each(function(b,c){a.push($(c).data("id"))}),this.imageCollection.findImage(a)},a.prototype.renderImage=function(a){this.page.getImagePlace().append($(nunjucks.render("grid.image.html.njs",{image:{src:a.getImageBase64(),name:a.getName(),id:a.getId(),label:a.getLabel()}})))},a}();a.GridView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.editor=b,this.$toolbar=this.editor.UI().getToolbarPlace()}return a.prototype.render=function(){this.$toolbar.html(""),null!==this.page.getParent()&&this.renderBackButton(this.$toolbar),this.renderCommonButton(this.$toolbar)},a.prototype.renderModuleToolbar=function(a,b){var c=this,d=this.editor.getModuleManager().getModules(this.editor.UI().getType(),null);d.forEach(function(a){var d=$(nunjucks.render("toolbar.button.html.njs",{button:{name:a.name(),icon:a.icon(),localizedName:a.name()}}));b.append(d),c.editor.UI().initModule(d,a)})},a.prototype.renderCommonButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"upload",icon:"fa fa-upload",localizedName:"upload"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"undo",icon:"fa fa-undo",localizedName:"undo"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"redo",icon:"fa fa-repeat",localizedName:"redo"}})))},a.prototype.renderBackButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"back",icon:"fa fa-arrow-left",localizedName:"back"}})))},a}();a.Toolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(1,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.GridToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(0,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.SingleToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){void 0===c&&(c=null),this.editor=a,this.imageCollection=b,this.parent=c}return b.prototype.hasParent=function(){return null!=this.parent},b.prototype.getParent=function(){return this.parent},b.prototype.appendImage=function(a){this.imageCollection.add(a)},b.prototype.getView=function(){return 1==this.imageCollection.getImages().length?new a.SingleView(this,this.imageCollection.getImages()[0]):new a.GridView(this,this.imageCollection)},b.prototype.getToolbar=function(){return 1==this.imageCollection.getImages().length?new a.SingleToolbar(this,this.editor.getEditor()):new a.GridToolbar(this,this.editor.getEditor())},b.prototype.render=function(){this.getToolbar().render(),this.getImagePlace().html(""),this.getView().render()},b.prototype.getImagePlace=function(){return this.editor.getImagePlace()},b}();a.Page=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(){}return a.init=function(a,b,c){0==b.type()?this.initAction(a,b,c):1==b.type()?this.initDelegate(a,b,c):alert("GROUP!!!")},a.initAction=function(){},a.initDelegate=function(a,b,c){a.click(function(){return b.init(c.UI().showPopover(b.html())),!1})},a}();a.ModuleInitialization=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){var d=this;this.$el=a,this.editor=b,this.images=c,this.page=null,this.$el.html(nunjucks.render("editor.html.njs",{}));var e=this.$el.find("#rsFileInput");e.on("change",function(){b.getLoader().load(this.files)}),this.$el.on("click","#t-button__upload",function(){return e.trigger("click"),!1}),this.$el.on("click",".rs-image-block, .rs-image-data__inf",function(a){d.editImage($(a.target).closest(".rs-image").data("id"))}),this.$el.on("click","#t-button__back",function(){return d.back(),!1}),this.$el.on("click",".rs-image-selection-checkbox",function(a){d.selectImage($(a.target).closest(".rs-image"))}),this.$toolbarPlace=this.$el.find("#rsToolbarPlace"),this.$popOver=this.$el.find("#rsPopover"),this.$imagePlace=this.$el.find("#rsImagePlace")}return b.prototype.initModule=function(b,c){a.ModuleInitialization.init(b,c,this.editor)},b.prototype.initToolbar=function(a){var b=this;a.find("#t-button__redo").click(function(){return b.redo(),!1}),a.find("#t-button__undo").click(function(){return b.undo(),!1})},b.prototype.redo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().redo())}),Promise.all(b).then(function(){a.getPage().getView().render()})},b.prototype.undo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().undo())}),Promise.all(b).then(function(){a.getPage().getView().render()})},b.prototype.showPopover=function(a){return this.$popOver.html(a),this.$popOver.show(),this.$popOver},b.prototype.back=function(){this.page.hasParent()&&(this.page=this.page.getParent(),this.render())},b.prototype.getImagePlace=function(){return this.$imagePlace},b.prototype.getToolbarPlace=function(){return this.$toolbarPlace},b.prototype.selected=function(){return this.getPage().getView().selected()},b.prototype.getEditor=function(){return this.editor},b.prototype.getPage=function(){return null==this.page&&(this.page=new a.Page(this,this.images)),this.page},b.prototype.getType=function(){return this.getPage().getView().type()},b.prototype.render=function(){this.getPage().render()},b.prototype.editImage=function(b){var c=this.images.getImage(b);this.page=new a.Page(this,c,this.page),this.render()},b.prototype.selectImage=function(a){a.hasClass("rs-image-selected")?a.removeClass("rs-image-selected"):a.addClass("rs-image-selected")},b}();a.Editor=b}(UI||(UI={}));var Core;!function(a){!function(a){a[a.SINGLE=0]="SINGLE",a[a.GRID=1]="GRID",a[a.ANY=2]="ANY"}(a.ModuleViewType||(a.ModuleViewType={}));var b=(a.ModuleViewType,function(){function a(a){this.editor=a,this.modules={},this.registerModule("resize",new Modules.ResizeModule(this.editor),2)}return a.prototype.registerModule=function(a,b,c){a in this.modules||(this.modules[a]={module:b,type:c})},a.prototype.getModule=function(a){if(a in this.modules)return this.modules[a].module;throw new Error("Invalid module name")},a.prototype.getModules=function(a,b){return void 0===a&&(a=2),void 0===b&&(b=null),_.map(this.modules,function(c){return c.type!=a&&2!=a&&2!=c.type||c.module.parent()!=b?void 0:c.module})},a}());a.ModuleManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.load=function(a){var b=this,c=0,d=new Promise(function(d){var e=setInterval(function(){if(c<a.length){var f=!1;c==a.length-1&&(f=!0),b.loadFile(a[c],d,f),c++}else clearInterval(e)},100)});d.then(function(){b.editor.UI().render()})},b.prototype.loadFile=function(b,c,d){var e=this;if(!b.type.match(/image.*/))return!1;var f=new FileReader;f.onload=function(f){var g=new a.RsImage(b.name,b.type);g.create(f.target.result).then(function(a){e.editor.appendImage(a),d&&c(1)})},f.readAsDataURL(b)},b}();a.ImageLoader=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b){this.imageManager=new a.ImageManager,this.ui=new UI.Editor(b,this,this.imageManager.newCollection([])),this.moduleManager=new a.ModuleManager(this),this.loader=new a.ImageLoader(this),this.ui.render()}return b.prototype.UI=function(){return this.ui},b.prototype.getModuleManager=function(){return this.moduleManager},b.prototype.appendImage=function(a){this.ui.getPage().appendImage(a)},b.prototype.getLoader=function(){return this.loader},b.prototype.getImageManager=function(){return this.imageManager},b}();a.RsImageEditor=b}(Core||(Core={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.html=function(){return nunjucks.render("resize.dialog.html.njs",{})},b.prototype.init=function(a){var b=this;a.find(".m_resize-ok").click(function(){return b.doAction(a.find(".m_resize-width").val(),a.find(".m_resize-height").val()),!1})},b.prototype.icon=function(){return"fa fa-expand"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"resize"},b.prototype.doAction=function(b,c){var d=this,e=[];this.editor.UI().selected().forEach(function(d){var f=new a.ResizeAction(d,b,c);e.push(d.getActionDispatcher().process(f))}),Promise.all(e).then(function(){d.editor.UI().getPage().getView().render()})},b}();a.ResizeModule=b}(Modules||(Modules={}));