!function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["color.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <input class="m_color-brightness" type="text" placeholder="width" value="100" /> <br />\n\n    <button class="m_color-ok" value="ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["crop.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <button id="crop_ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <input class="m_resize-width" type="text" placeholder="width" value="150" /> <br />\n    <input class="m_resize-height" type="text" placeholder="height"value="100" /> <br /> <br />\n\n    <button class="m_resize-ok" value="ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["editor.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-editor-block">\n    <input type="file" id="rsFileInput" style="display: none" multiple />\n    <div id="rsToolbarPlace" class="rs-toolbar"></div>\n    <div class="rs-content">\n        <div id="rsImagePlace" class="rs-image-place"></div>\n        <div id="rsPopover" class="rs-popover hide"></div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-image" data-id="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"id",a.autoesc),a.autoesc),h+='">\n    <div class="rs-image-block">\n        <!--<img src="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='" />-->\n    </div>\n    <div class="rs-image-data">\n        <div class="rs-image-data__inf">\n            <div class="rs-image-data__label">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"label",a.autoesc),a.autoesc),h+='</div>\n            <div class="rs-image-data__name">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"name",a.autoesc),a.autoesc),h+='</div>\n        </div>\n        <div class="rs-image-data__select">\n            <input type="checkbox" class="rs-image-selection-checkbox" />\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-single-image">\n    <div class="rs-canvas-place" id="rsSingleImage">\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["toolbar.button.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div id="t-button__',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"name",a.autoesc),a.autoesc),h+='" class="rs-toolbar-button">\n    ',""!=d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc)?(h+='\n    <i class="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc),a.autoesc),h+='"></i>\n    '):(h+="\n        ",h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"localizedName",a.autoesc),a.autoesc),h+="\n    "),h+="\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}();var Core;!function(a){var b=function(){function a(a){this.current=-1,this.image=a,this.actions=[],this.actionsResult=[]}return a.prototype.process=function(a){return this.actions=this.actions.splice(this.current),this.actions.push(a),this.current++,this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)},a.prototype.undo=function(){if(this.current>=0){var a=this.actions[this.current];return this.current--,this.actionsResult.push(this.doAction(a.unExecute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.redo=function(){if(this.current<this.actions.length-1){this.current++;var a=this.actions[this.current];return this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.doAction=function(a,b){var c=this;return 0==this.actionsResult.length?a.apply(b):new Promise(function(d){_.last(c.actionsResult).then(function(){a.apply(b).then(function(a){d(a)})})})},a}();a.ActionDispatcher=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b,c){this.imageName=b,this.imageType=c,this.id="",this.actionDispatcher=null,this.imageBase64="",this.actionDispatcher=new a.ActionDispatcher(this)}return b.prototype.create=function(a){var b=this;return this.imageBase64=a,new Promise(function(a){b.getImage().then(function(c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=c.width,d.height=c.height,e.drawImage(c,0,0),b.originalImage=e.getImageData(0,0,c.width,c.height),b.init(),a(b)})})},b.prototype.init=function(){this.processedImage=this.originalImage,this.width=this.originalImage.width,this.height=this.originalImage.height,this.brightness=0},b.prototype.getOriginalCoordinates=function(a,b){return{x:this.originalImage.width*a/this.processedImage.width,y:this.originalImage.height*b/this.processedImage.height}},b.prototype.getOriginalImage=function(){return this.originalImage},b.prototype.replaceOriginal=function(a){this.originalImage=a},b.prototype.crop=function(a,b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d");e.width=this.originalImage.width,e.height=this.originalImage.height,f.putImageData(this.originalImage,0,0);var g=this.getOriginalCoordinates(a,b),h=this.getOriginalCoordinates(c,d);this.originalImage=f.getImageData(g.x,g.y,h.x,h.y),this.width=c,this.height=d},b.prototype.save=function(){var b=this,c=document.createElement("canvas"),d=c.getContext("2d");c.width=this.width,c.height=this.height,d.putImageData(this.originalImage,0,0);var e;return e=this.width!=this.originalImage.width||this.height!=this.originalImage.height?new a.ImageResizer(this.originalImage,this.width,this.height).resize():Promise.resolve(d.getImageData(0,0,this.width,this.height)),e.then(function(a){return c.width=a.width,c.height=a.height,d.putImageData(a,0,0),new Promise(function(e){var f=b;Caman(c,function(){var b=this;b.brightness(f.brightness),b.render(function(){e(d.getImageData(0,0,a.width,a.height))})})})}).then(function(a){b.processedImage=a;var c=document.createElement("canvas"),d=c.getContext("2d");return c.width=b.processedImage.width,c.height=b.processedImage.height,d.putImageData(b.processedImage,0,0),b.imageBase64=c.toDataURL(),b})},b.prototype.getImageData=function(){return this.processedImage},b.prototype.getWidth=function(){return this.processedImage.width},b.prototype.getHeight=function(){return this.processedImage.height},b.prototype.getName=function(){return this.imageName},b.prototype.getLabel=function(){return""},b.prototype.getImageBase64=function(){return this.imageBase64},b.prototype.getActionDispatcher=function(){return this.actionDispatcher},b.prototype.setId=function(a){this.id=a},b.prototype.getId=function(){return this.id},b.prototype.getImage=function(){var a=this;return new Promise(function(b){var c=new Image;c.onload=function(){b(c)},c.src=a.imageBase64})},b}();a.RsImage=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a,b,c,d){this.r=a,this.g=b,this.b=c,this.a=d}return a.prototype.devig=function(a){return this.r/=a,this.g/=a,this.b/=a,this.a/=a,this},a}(),c=function(){function a(a,b,c){this.original=a,this.newWidth=b,this.newHeight=c,this.size=this.original.data.length}return a.prototype.resize=function(){var a=this.getWidthGridSize(),b=this.getHeightGridSize();return a>2&&b>2?Promise.resolve(this.downScaleSuperSampling(a,b)):this.upScale()},a.prototype.upScale=function(){var a=this,b=document.createElement("canvas"),c=b.getContext("2d");b.width=this.original.width,b.height=this.original.height,c.putImageData(this.original,0,0);var d=new Image;return new Promise(function(e){d.onload=function(){b.width=a.newWidth,b.height=a.newHeight,c.drawImage(d,0,0,a.newWidth,a.newHeight),e(c.getImageData(0,0,a.newWidth,a.newHeight))},d.src=b.toDataURL()})},a.prototype.downScaleSuperSampling=function(a,b){for(var c=document.createElement("canvas"),d=c.getContext("2d"),e=d.createImageData(this.newWidth,this.newHeight),f=this.cutImageData(a,b),g=0,h=0;h<this.newHeight;h++)for(var i=0;i<this.newWidth;i++){var j=f[h][i];j&&(e.data[g]=j.r,e.data[g+1]=j.g,e.data[g+2]=j.b,e.data[g+3]=j.a,g+=4)}return e},a.prototype.cutImageData=function(a,c){for(var d=0,e=[],f=0;f<this.original.height;f+=c){e[d]=[];for(var g=0;g<this.original.width;g+=a){for(var h=new b(0,0,0,0),i=0,j=f;f+c>j;j++)for(var k=g;g+a>k;k++){var l=4*(j*this.original.width+k);l+3<this.size&&(h.r=h.r+this.original.data[l],h.g=h.g+this.original.data[l+1],h.b=h.b+this.original.data[l+2],h.a=h.a+this.original.data[l+3],i++)}e[d].push(h.devig(i))}d++}return e},a.prototype.getWidthGridSize=function(){return Math.floor(this.original.width/this.newWidth)},a.prototype.getHeightGridSize=function(){return Math.floor(this.original.height/this.newHeight)},a}();a.ImageResizer=c}(Core||(Core={}));var Modules;!function(a){var b=function(){function a(a,b){this.image=a,this.brightness=b}return a.prototype.execute=function(){return this.oldBrightness=this.image.brightness,this.image.brightness=this.brightness,this.image.save()},a.prototype.unExecute=function(){return this.image.brightness=this.oldBrightness,this.image.save()},a}();a.BrightnessAction=b}(Modules||(Modules={}));var Core;!function(a){!function(a){a[a.ACTION=0]="ACTION",a[a.DELEGATE=1]="DELEGATE",a[a.GROUP=2]="GROUP"}(a.ModuleType||(a.ModuleType={}));a.ModuleType}(Core||(Core={}));var Core;!function(a){var b=function(){function b(){this.images={},this.collections=[]}return b.prototype.newCollection=function(b){var c=new a.ImageCollection(this);for(var d in b)c.add(d);return this.collections.push(c),c},b.prototype.tryAdd=function(a){if(""==a.getId()){for(var b=Math.random().toString(36).substring(7);_.has(this.images,b);)b=Math.random().toString(36).substring(7);a.setId(b),this.add(a)}},b.prototype.add=function(a){this.images[a.getId()]=a},b.prototype.has=function(a){return _.has(this.images,a.getId())},b.prototype.remove=function(){},b}();a.ImageManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a){this.manager=a,this.images=[]}return a.prototype.add=function(a){this.manager.tryAdd(a),this.images.push(a)},a.prototype.has=function(a){return this.images.indexOf(a)>-1},a.prototype.remove=function(a){var b=this.images.indexOf(a);b>-1&&this.images.splice(b,1)},a.prototype.getImages=function(){return this.images},a.prototype.getImage=function(b){var c=new a(this.manager);return this.images.forEach(function(a){a.getId()==b&&c.add(a)}),c},a.prototype.findImage=function(a){var b=[];return this.images.forEach(function(c){_.contains(a,c.getId())&&b.push(c)}),b},a}();a.ImageCollection=b}(Core||(Core={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.image=b,this.canvas=null}return a.prototype.type=function(){return 0},a.prototype.render=function(){this.page.getImagePlace().html(nunjucks.render("single.image.html.njs",{})),this.getCanvas(),this.renderImage()},a.prototype.selected=function(){return[this.image]},a.prototype.getAreaElement=function(){return this.page.getImagePlace().find("#rsSingleImage")},a.prototype.renderImage=function(){this.context.putImageData(this.image.getImageData(),0,0)},a.prototype.getCanvas=function(){var a=this.page.getImagePlace().find("#"+this.image.getId());0==a.length&&this.page.getImagePlace().find("#rsSingleImage").html('<canvas id="'+this.image.getId()+'"></canvas>'),this.canvas=this.page.getImagePlace().find("#"+this.image.getId())[0],this.canvas.width=this.image.getWidth(),this.canvas.height=this.image.getHeight(),this.context=this.canvas.getContext("2d")},a}();a.SingleView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.imageCollection=b}return a.prototype.type=function(){return 1},a.prototype.render=function(){var a=this;this.page.getImagePlace().html("");var b=this.imageCollection.getImages();if(b.length>0)var c=0,d=setInterval(function(){a.renderImage(b[c]),c++,c==b.length&&clearInterval(d)},10)},a.prototype.selected=function(){var a=[];return this.page.getImagePlace().find(".rs-image-selected").each(function(b,c){a.push($(c).data("id"))}),this.imageCollection.findImage(a)},a.prototype.renderImage=function(a){var b=$(nunjucks.render("grid.image.html.njs",{image:{name:a.getName(),id:a.getId(),label:a.getLabel()}}));this.page.getImagePlace().append(b);var c=$('<canvas id="'+a.getId()+'"></canvas>');b.find(".rs-image-block").append(c);var d=c[0],e=d.getContext("2d");d.width=150,d.height=120,new Core.ImageResizer(a.getImageData(),150,120).resize().then(function(a){e.putImageData(a,0,0)})},a}();a.GridView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.editor=b,this.$toolbar=this.editor.UI().getToolbarPlace()}return a.prototype.render=function(){this.$toolbar.html(""),null!==this.page.getParent()&&this.renderBackButton(this.$toolbar),this.renderCommonButton(this.$toolbar)},a.prototype.renderModuleToolbar=function(a,b){var c=this,d=this.editor.getModuleManager().getModules(this.editor.UI().getType(),null);d.forEach(function(a){var d=$(nunjucks.render("toolbar.button.html.njs",{button:{name:a.name(),icon:a.icon(),localizedName:a.name()}}));b.append(d),c.editor.UI().initModule(d,a)})},a.prototype.renderCommonButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"upload",icon:"fa fa-upload",localizedName:"upload"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"undo",icon:"fa fa-undo",localizedName:"undo"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"redo",icon:"fa fa-repeat",localizedName:"redo"}})))},a.prototype.renderBackButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"back",icon:"fa fa-arrow-left",localizedName:"back"}})))},a}();a.Toolbar=b}(UI||(UI={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(1,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.GridToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderModuleToolbar(0,this.$toolbar),this.editor.UI().initToolbar(this.$toolbar)},b}(a.Toolbar);a.SingleToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){void 0===c&&(c=null),this.editor=a,this.imageCollection=b,this.parent=c}return b.prototype.hasParent=function(){return null!=this.parent},b.prototype.getParent=function(){return this.parent},b.prototype.appendImage=function(a){this.imageCollection.add(a)},b.prototype.getView=function(){return 1==this.imageCollection.getImages().length?new a.SingleView(this,this.imageCollection.getImages()[0]):new a.GridView(this,this.imageCollection)},b.prototype.getToolbar=function(){return 1==this.imageCollection.getImages().length?new a.SingleToolbar(this,this.editor.getEditor()):new a.GridToolbar(this,this.editor.getEditor())},b.prototype.render=function(){this.getToolbar().render(),this.getImagePlace().html(""),this.getView().render()},b.prototype.getImagePlace=function(){return this.editor.getImagePlace()},b}();a.Page=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(){}return a.init=function(a,b,c){return 0==b.type()?this.initAction(a,b,c):1==b.type()?this.initDelegate(a,b,c):alert("GROUP!!!"),b},a.initAction=function(){},a.initDelegate=function(a,b,c){a.click(function(){return null!=c.UI().getActiveModule()&&c.UI().getActiveModule().deinit(),b.init(c.UI().showPopover(b.html())),c.UI().setActiveModule(b),!1})},a}();a.ModuleInitialization=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){var d=this;this.$el=a,this.editor=b,this.images=c,this.page=null,this.activeModule=null,this.$el.html(nunjucks.render("editor.html.njs",{}));var e=this.$el.find("#rsFileInput");e.on("change",function(){b.getLoader().load(this.files)}),this.$el.on("click","#t-button__upload",function(){return e.trigger("click"),!1}),this.$el.on("click",".rs-image-block, .rs-image-data__inf",function(a){d.editImage($(a.target).closest(".rs-image").data("id"))}),this.$el.on("click","#t-button__back",function(){return d.back(),!1}),this.$el.on("click",".rs-image-selection-checkbox",function(a){d.selectImage($(a.target).closest(".rs-image"))}),this.$toolbarPlace=this.$el.find("#rsToolbarPlace"),this.$popOver=this.$el.find("#rsPopover"),this.$imagePlace=this.$el.find("#rsImagePlace")}return b.prototype.initModule=function(b,c){a.ModuleInitialization.init(b,c,this.editor)},b.prototype.getActiveModule=function(){return this.activeModule},b.prototype.setActiveModule=function(a){this.activeModule=a},b.prototype.initToolbar=function(a){var b=this;a.find("#t-button__redo").click(function(){return b.redo(),!1}),a.find("#t-button__undo").click(function(){return b.undo(),!1})},b.prototype.getView=function(){return this.getPage().getView()},b.prototype.redo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().redo())}),Promise.all(b).then(function(){a.getPage().getView().render()})},b.prototype.undo=function(){var a=this,b=[];this.selected().forEach(function(a){b.push(a.getActionDispatcher().undo())}),Promise.all(b).then(function(){a.getPage().getView().render()})},b.prototype.showPopover=function(a){return this.$popOver.html(a),this.$popOver.show(),this.$popOver},b.prototype.back=function(){this.page.hasParent()&&(this.page=this.page.getParent(),this.render())},b.prototype.getImagePlace=function(){return this.$imagePlace},b.prototype.getToolbarPlace=function(){return this.$toolbarPlace},b.prototype.selected=function(){return this.getPage().getView().selected()},b.prototype.getEditor=function(){return this.editor},b.prototype.getPage=function(){return null==this.page&&(this.page=new a.Page(this,this.images)),this.page},b.prototype.getType=function(){return this.getPage().getView().type()},b.prototype.render=function(){this.getPage().render()},b.prototype.editImage=function(b){var c=this.images.getImage(b);this.page=new a.Page(this,c,this.page),this.render()},b.prototype.selectImage=function(a){a.hasClass("rs-image-selected")?a.removeClass("rs-image-selected"):a.addClass("rs-image-selected")},b}();a.Editor=b}(UI||(UI={}));var Core;!function(a){!function(a){a[a.SINGLE=0]="SINGLE",a[a.GRID=1]="GRID",a[a.ANY=2]="ANY"}(a.ModuleViewType||(a.ModuleViewType={}));var b=(a.ModuleViewType,function(){function a(a){this.editor=a,this.modules={},this.registerModule("resize",new Modules.ResizeModule(this.editor),2),this.registerModule("color",new Modules.ColorModule(this.editor),2),this.registerModule("crop",new Modules.CropModule(this.editor),2)}return a.prototype.registerModule=function(a,b,c){a in this.modules||(this.modules[a]={module:b,type:c})},a.prototype.getModule=function(a){if(a in this.modules)return this.modules[a].module;throw new Error("Invalid module name")},a.prototype.getModules=function(a,b){return void 0===a&&(a=2),void 0===b&&(b=null),_.map(this.modules,function(c){return c.type!=a&&2!=a&&2!=c.type||c.module.parent()!=b?void 0:c.module})},a}());a.ModuleManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.load=function(a){var b=this,c=0,d=new Promise(function(d){var e=setInterval(function(){if(c<a.length){var f=!1;c==a.length-1&&(f=!0),b.loadFile(a[c],d,f),c++}else clearInterval(e)},100)});d.then(function(){b.editor.UI().render()})},b.prototype.loadFile=function(b,c,d){var e=this;if(!b.type.match(/image.*/))return!1;var f=new FileReader;f.onload=function(f){var g=new a.RsImage(b.name,b.type);g.create(f.target.result).then(function(a){e.editor.appendImage(a),d&&c(1)})},f.readAsDataURL(b)},b}();a.ImageLoader=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b){this.imageManager=new a.ImageManager,this.ui=new UI.Editor(b,this,this.imageManager.newCollection([])),this.moduleManager=new a.ModuleManager(this),this.loader=new a.ImageLoader(this),this.ui.render()}return b.prototype.UI=function(){return this.ui},b.prototype.getModuleManager=function(){return this.moduleManager},b.prototype.appendImage=function(a){this.ui.getPage().appendImage(a)},b.prototype.getLoader=function(){return this.loader},b.prototype.getImageManager=function(){return this.imageManager},b}();a.RsImageEditor=b}(Core||(Core={}));var UI;!function(a){var b;!function(a){var b=function(){function a(){this.events={}}return a.prototype.on=function(a,b,c){void 0===c&&(c="_"),_.has(this.events,a)||(this.events[a]={}),_.has(this.events[a],c)||(this.events[a][c]=[]),this.events[a][c].push(b)},a.prototype.off=function(a){var b=this;void 0===a&&(a="_"),_.map(this.events,function(c,d){b.events[d]=_.omit(c,a)})},a.prototype.trigger=function(a,b){var c=this;void 0===b&&(b=null),_.has(this.events,a)&&_.map(this.events[a],function(a){a.forEach(function(a){a({data:b,widget:c})})})},a}();a.RsWidget=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f){var g=this;void 0===e&&(e=1),void 0===f&&(f=0),a.call(this),this.$el=b,this.min=c,this.max=d,this.step=e,this.start=f,this.$slider=$('<div class="rs-slider-handle"></div>'),this.$el.html(""),this.$el.addClass("rs-slider"),this.$el.append(this.$slider),this.$slider.css("left",this.getPixelPos(this.start)+"px");var h=$(document);this.$slider.mousedown(function(a){var b=a.clientX-parseInt(g.$slider.css("left"));h.on("mousemove.RsSlider",function(a){var c=a.clientX-b;0>c&&(c=0);var d=g.$el.width()-g.$slider.width();c>d&&(c=d),g.$slider.css("left",c+"px"),g.trigger("move",g.getVal(c))}),h.on("mouseup.RsSlider",function(){h.off(".RsSlider")})})}return __extends(b,a),b.prototype.getVal=function(a){return Math.round(a*((this.max-this.min)/this.step)/(this.$el.width()-this.$slider.width()))*this.step+this.min},b.prototype.getPixelPos=function(a){return(a-this.min)/this.step*(this.$el.width()-this.$slider.width())/((this.max-this.min)/this.step)},b}(a.RsWidget);a.RsSlider=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.html=function(){return nunjucks.render("color.dialog.html.njs",{})},b.prototype.init=function(a){var b=this;a.find(".m_color-ok").click(function(){return b.doAction(a.find(".m_color-brightness").val()),!1})},b.prototype.deinit=function(){},b.prototype.icon=function(){return"fa fa-image"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"resize"},b.prototype.doAction=function(b){var c=this,d=[];this.editor.UI().selected().forEach(function(c){var e=new a.BrightnessAction(c,b);d.push(c.getActionDispatcher().process(e))}),Promise.all(d).then(function(){c.editor.UI().getPage().getView().render()})},b}();a.ColorModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c,d,e){this.image=a,this.left=b,this.top=c,this.width=d,this.height=e}return a.prototype.execute=function(){return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.originalImage=this.image.getOriginalImage(),this.image.crop(this.left,this.top,this.width,this.height),this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.replaceOriginal(this.originalImage),this.image.save()},a}();a.CropAction=b}(Modules||(Modules={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b,c,d){a.call(this),this.$el=b,this.$parent=c,this.index=d,this.itemHalfSize=5,this.init()}return __extends(b,a),b.prototype.getElementCorners=function(){var a={x:this.$el.position().left,y:this.$el.position().top},b={x:a.x+this.$el.width(),y:a.y},c={x:a.x+this.$el.width(),y:a.y+this.$el.height()},d={x:a.x,y:a.y+this.$el.height()};return{topLeft:a,topRight:b,bottomRight:c,bottomLeft:d}},b.prototype.getPosition=function(){return this.position},b.prototype.getIndex=function(){return this.index},b.prototype.toPlace=function(){var a,b=this.getElementCorners();0==this.index?a=b.topLeft:1==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.topRight.y}:2==this.index?a=b.topRight:3==this.index?a={x:b.topRight.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}:4==this.index?a=b.bottomRight:5==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.bottomRight.y}:6==this.index?a=b.bottomLeft:7==this.index&&(a={x:b.topLeft.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}),this.position=a,this.$item.css({left:a.x-this.itemHalfSize+"px",top:a.y-this.itemHalfSize+"px"})},b.prototype.init=function(){var a=this;this.$item=$('<div class="rs-resizable-item item_'+this.index+'"></div>'),this.$parent.append(this.$item),this.toPlace();var b=$(document);this.$item.mousedown(function(c){var d=c.clientX-parseInt(a.$item.css("left"))-a.itemHalfSize,e=c.clientY-parseInt(a.$item.css("top"))-a.itemHalfSize;b.on("mousemove.RsResize_"+a.index,function(b){var c={x:b.clientX-d,y:b.clientY-e};a.moveItem(c),a.trigger("move",{index:a.index,newPosition:a.position,oldPosition:{x:d,y:e}})}),b.on("mouseup.RsResize_"+a.index,function(){b.off(".RsResize_"+a.index)})})},b.prototype.moveItem=function(a){var b=this.getElementCorners();(0==this.index||7==this.index||6==this.index)&&a.x>=b.topRight.x-10&&(a.x=b.topRight.x-10),(0==this.index||1==this.index||2==this.index)&&a.y>=b.bottomRight.y-10&&(a.y=b.bottomRight.y-10),this.$item.css(1==this.index||5==this.index?{top:a.y-5+"px"}:7==this.index||3==this.index?{left:a.x-5+"px"}:{left:a.x-5+"px",top:a.y-5+"px"}),this.position={x:parseInt(this.$item.css("left"))+5,y:parseInt(this.$item.css("top"))+5}},b}(a.RsWidget),c=function(a){function c(c,d){var e=this;a.call(this),this.$el=c,this.$parent=d,this.items=[],this.$el.addClass("rs-resizable");for(var f=0;8>f;f++){var g=new b(this.$el,this.$parent,f);this.items.push(g),g.on("move",function(a){e.onItemMove(a.data.index,a.data.newPosition,a.data.oldPosition)})}var h=$(document);this.$el.mousedown(function(a){var b=a.clientX-parseInt(e.$el.css("left")),c=a.clientY-parseInt(e.$el.css("top"));h.on("mousemove.RsResize",function(a){var d={x:a.clientX-b,y:a.clientY-c};e.$el.css({left:d.x,top:d.y}),e.updateItems()}),h.on("mouseup.RsResize",function(){h.off(".RsResize")})})}return __extends(c,a),c.prototype.onItemMove=function(a,b){0==a?(this.$el.css({left:b.x+"px",top:b.y+"px",width:this.items[4].getPosition().x-b.x+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):1==a?(this.$el.css({top:b.y+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):2==a?(this.$el.css({right:b.x+"px",top:b.y+"px",width:b.x-this.items[6].getPosition().x+"px",height:this.items[6].getPosition().y-b.y+"px"}),this.updateItems([6])):3==a?(this.$el.css({right:b.x+"px",width:b.x-this.items[6].getPosition().x+"px"}),this.updateItems([6])):4==a?(this.$el.css({right:b.x+"px",bottom:b.y+"px",width:b.x-this.items[0].getPosition().x+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):5==a?(this.$el.css({bottom:b.y+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):6==a?(this.$el.css({left:b.x+"px",bottom:b.y+"px",width:this.items[2].getPosition().x-b.x+"px",height:b.y-this.items[2].getPosition().y+"px"}),this.updateItems([2])):7==a&&(this.$el.css({left:b.x+"px",width:this.items[2].getPosition().x-b.x+"px"}),this.updateItems([2]))},c.prototype.getBounds=function(){return{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}},c.prototype.updateItems=function(a){void 0===a&&(a=[]),this.trigger("resize",{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}),this.items.forEach(function(b){_.contains(a,b.getIndex())||b.toPlace()})},c}(a.RsWidget);a.RsResizable=c}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.view=null}return b.prototype.html=function(){return nunjucks.render("crop.dialog.html.njs",{})},b.prototype.deinit=function(){null!=this.view&&(this.$cropRect.remove(),this.view.getAreaElement().find(".rs-resizable-item").remove())},b.prototype.init=function(){var a=this;0==this.editor.UI().getType()&&(this.view=this.editor.UI().getView(),this.$cropRect=$('<div class="crop-rect"></div>'),this.view.getAreaElement().append(this.$cropRect),this.cropResizableWidget=new UI.Widgets.RsResizable(this.$cropRect,this.view.getAreaElement()),$("#crop_ok").click(function(){var b=a.cropResizableWidget.getBounds();a.doAction(b.left,b.top,b.width,b.height)}))},b.prototype.icon=function(){return"fa fa-crop"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"crop"},b.prototype.doAction=function(b,c,d,e){var f=this,g=[];this.editor.UI().selected().forEach(function(f){var h=new a.CropAction(f,b,c,d,e);g.push(f.getActionDispatcher().process(h))}),Promise.all(g).then(function(){f.editor.UI().getPage().getView().render()})},b}();a.CropModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c){this.image=a,this.width=b,this.height=c}return a.prototype.execute=function(){return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.image.width=this.width,this.image.height=this.height,this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.save()},a}();a.ResizeAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a}return b.prototype.html=function(){return nunjucks.render("resize.dialog.html.njs",{})},b.prototype.deinit=function(){},b.prototype.init=function(a){var b=this;a.find(".m_resize-ok").click(function(){return b.doAction(a.find(".m_resize-width").val(),a.find(".m_resize-height").val()),!1})},b.prototype.icon=function(){return"fa fa-expand"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"resize"},b.prototype.doAction=function(b,c){var d=this,e=[];this.editor.UI().selected().forEach(function(d){var f=new a.ResizeAction(d,b,c);e.push(d.getActionDispatcher().process(f))}),Promise.all(e).then(function(){d.editor.UI().getPage().getView().render()})},b}();a.ResizeModule=b}(Modules||(Modules={}));