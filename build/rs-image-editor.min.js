!function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["color.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Color</h2>\n</div>\n<div class="m__color-item">\n    Red\n    <div class="m__color-slider" data-name="red" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__color-item">\n    Green\n    <div  class="m__color-slider" data-name="green" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__color-item">\n    Blue\n    <div class="m__color-slider" data-name="blue" data-min="-100" data-max="100" data-step="1"></div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["crop.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <button id="crop_ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["crop-resize.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="crop-resize">\n    <div class="crop-resize__action fit">\n        <h2>Fit to a rect</h2>\n\n        <div class="fit__sizes sizes">\n            <div class="sizes__width">\n                <label for="fitSizesWidth">Width</label><br />\n                <input type="number" id="fitSizesWidth"  /> px\n            </div>\n            <div class="sizes__height">\n                <label for="fitSizesHeight">Height</label><br />\n                <input type="number" id="fitSizesHeight" /> px\n            </div>\n        </div>\n\n        <div class="fit__methods">\n            <p>Choose Method:</p>\n            <ul class="module-list">\n                <li data-value="resize-all">Resizing on all sides</li>\n                <li data-value="stretch-to-width">Stretch width</li>\n                <li data-value="stretch-to-height">Stretch height</li>\n                <li data-value="stretch-to-rect">Stretch to rect</li>\n            </ul>\n\n            <div class="fit__methods-canvas">\n                <canvas id="fitCanvas"></canvas>\n            </div>\n        </div>\n\n        <div class="fit__method-position methods">\n            <p>Position:</p>\n            <div class="fit-position methods-list" id="fitPosition">\n                <div class="fp fp-left-top selected" style="left: 0; top: 0"></div>\n                <div class="fp fp-top" style="left: 20px; top: 0"></div>\n                <div class="fp fp-right-top" style="right: 0; top: 0"></div>\n                <div class="fp fp-left" style="left: 0; top: 20px"></div>\n                <div class="fp fp-right" style="right: 0; top: 20px"></div>\n                <div class="fp fp-left-bottom" style="left: 0; bottom: 0"></div>\n                <div class="fp fp-bottom" style="left: 20px; bottom: 0"></div>\n                <div class="fp fp-right-bottom" style="right: 0; bottom: 0"></div>\n            </div>\n        </div>\n\n        <div class="fit-crop__button">\n            <input type="checkbox" id="fitCrop" checked /> <label for="fitCrop">Crop image if its size is larger than the size of rectangle</label>\n        </div>\n\n        <div class="fit__button">\n            <button class="fit-button crop-button">Apply</button>\n        </div>\n    </div>\n\n    <div class="crop-resize__action crop" style="margin-top: 20px">\n        <h2>Crop</h2>\n\n        <div class="crop-sizes sizes">\n            <div class="crop__width">\n                <label for="cropSizesWidth">Width</label><br />\n                <input type="number" id="cropSizesWidth"  /> px\n            </div>\n            <div class="crop__height">\n                <label for="cropSizesHeight">Height</label><br />\n                <input type="number" id="cropSizesHeight" /> px\n            </div>\n        </div>\n\n        <div class="crop__method-position methods">\n            <p>Position:</p>\n            <div class="crop-position methods-list" id="cropPosition">\n                <div class="fp fp-left-top selected" style="left: 0; top: 0"></div>\n                <div class="fp fp-top" style="left: 20px; top: 0"></div>\n                <div class="fp fp-right-top" style="right: 0; top: 0"></div>\n                <div class="fp fp-left" style="left: 0; top: 20px"></div>\n                <div class="fp fp-center" style="left: 20px; top: 20px"></div>\n                <div class="fp fp-right" style="right: 0; top: 20px"></div>\n                <div class="fp fp-left-bottom" style="left: 0; bottom: 0"></div>\n                <div class="fp fp-bottom" style="left: 20px; bottom: 0"></div>\n                <div class="fp fp-right-bottom" style="right: 0; bottom: 0"></div>\n            </div>\n        </div>\n\n        <div class="fit__button">\n            <button class="crop-button" id="cropButton">Crop</button>\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["filter.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="m-filter">\n    <div class="m-filter__canvas">\n        <canvas id="mFilter-',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"filter"),"name",a.autoesc),a.autoesc),h+='" width="50" height="30"></canvas>\n    </div>\n\n    <div class="m-filter__name">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"filter"),"displayName",a.autoesc),a.autoesc),h+='</div>\n\n    <div class="m-filter__vignette">\n        <input type="checkbox" checked id="mFilter-',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"filter"),"name",a.autoesc),a.autoesc),h+='-vignette" /> <br />\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["filters.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Filters</h2>\n</div>\n\n<div class="m-filters__filters-list">\n\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Image</h2>\n</div>\n<div class="m__image-item">\n    Brightness\n    <div class="m__image-slider" data-name="brightness" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Vibrance\n    <div  class="m__image-slider" data-name="vibrance" data-min="-200" data-max="200" data-step="10"></div>\n</div>\n<div class="m__image-item">\n    Hue\n    <div class="m__image-slider" data-name="hue" data-min="0" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Gamma\n    <div class="m__image-slider" data-name="gamma" data-min="0" data-max="10" data-step="0.1"></div>\n</div>\n<div class="m__image-item">\n    Clip\n    <div class="m__image-slider" data-name="clip" data-min="0" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Stack Blur\n    <div class="m__image-slider" data-name="stackBlur" data-min="0" data-max="20" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Contrast\n    <div class="m__image-slider" data-name="contrast" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Saturation\n    <div class="m__image-slider" data-name="saturation" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Exposure\n    <div class="m__image-slider" data-name="exposure" data-min="-100" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Sepia\n    <div class="m__image-slider" data-name="sepia" data-min="0" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Noise\n    <div class="m__image-slider" data-name="noise" data-min="0" data-max="100" data-step="1"></div>\n</div>\n<div class="m__image-item">\n    Sharpen\n    <div class="m__image-slider" data-name="sharpen" data-min="0" data-max="100" data-step="1"></div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize-grid.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <input class="m_resize-width" type="text" placeholder="width" value="150" /> <br />\n    <input class="m_resize-height" type="text" placeholder="height"value="100" /> <br /> <br />\n\n    <button class="m_resize-ok" value="ok">OK!</button>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["resize-single.dialog.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div>\n    <h2>Size</h2>\n</div>\n\n<div class="m__single-resize">\n    <div class="m__single-resize__val width">\n        Width <br />\n        <input type="number" /> px\n    </div>\n\n    <div class="m__single-resize__lock">\n        <i class="\n        ',h+=d.contextOrFrameLookup(b,c,"isLocked")?"\n        fa fa-lock\n        ":"\n        fa fa-unlock\n        ",h+='"></i>\n    </div>\n\n    <div class="m__single-resize__val height">\n        Height <br />\n        <input type="number" /> px\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["editor.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-editor-block">\n    <input type="file" id="rsFileInput" style="display: none" multiple />\n    <div id="rsToolbarPlace" class="rs-toolbar">\n        <div id="rsToolbarMainAction" class="rs-toolbar-button-block"></div>\n        <div id="rsToolbarEditorAction" class="rs-toolbar-button-block rs-editor-toolbar"></div>\n    </div>\n    <div class="rs-progress-bar" id="rsProgressBar">\n\n    </div>\n    <div class="rs-content">\n        <div id="rsImagePlace" class="rs-image-place"></div>\n        <div class="rs-popover">\n            <div id="rsPopover"></div>\n            <div id="rsInformation" class="rs-information">\n\n            </div>\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-image" data-id="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"id",a.autoesc),a.autoesc),h+='" id="img__',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"id",a.autoesc),a.autoesc),h+='">\n    <div class="rs-image-block">\n        <!--<img src="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='" />-->\n        <!--',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"src",a.autoesc),a.autoesc),h+='-->\n    </div>\n    <div class="rs-image-data">\n        <div class="rs-image-data__inf">\n            <div class="rs-image-data__label">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"label",a.autoesc),a.autoesc),h+='</div>\n            <div class="rs-image-data__name">',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"image"),"name",a.autoesc),a.autoesc),h+='</div>\n        </div>\n        <div class="rs-image-data__select">\n            <input type="checkbox" class="rs-image-selection-checkbox" />\n        </div>\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["grid.information.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<h2 class="rs-information__title">\n    Select\n</h2>\n<div class="rs-information__select" id="rsSelect">\n    <div class="rs-select">\n        Select <a href="#all" class="rs-select__link" id="rsSelectAll">all</a>, <a href="#new" id="rsSelectNew" class="rs-select__link">new</a> images\n    </div>\n    <div class="rs-select rs-select__deselect">\n        <a href="#deselect" id="rsDeselectAll">Deselect all</a>\n    </div>\n</div>\n\n\n<h2 class="rs-information__title">\n    Information\n</h2>\n<div class="rs-information__total">\n    <div>\n        Pictures <br />\n        <b>',h+=d.suppressValue(d.contextOrFrameLookup(b,c,"count"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Min resolution <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"minResolution"),a.autoesc),h+="</b>\n    </div>\n\n    <div>\n        Max resolution<br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"maxResolution"),a.autoesc),h+='</b>\n    </div>\n</div>\n<div class="rs-information__resolution">\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.image.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div class="rs-single-image">\n    <div class="rs-canvas-place" id="rsSingleImage">\n    </div>\n</div>',e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["single.information.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<h2 class="rs-information__title">\n    Zoom\n</h2>\n<div class="rs-information__zoom">\n    <a href="#to-width" id="fitToWidth">Fit to width</a>\n    <a href="#source" id="sourceSize">Original size</a>\n\n    <div class="rs-information__zoom-value">\n        Actual zoom: <b id="zoomValue">100%</b>\n    </div>\n</div>\n\n<h2 class="rs-information__title">\n    Information\n</h2>\n<div class="rs-information__total">\n    <div>\n        Resolution <br />\n        <b>',h+=d.suppressValue(d.contextOrFrameLookup(b,c,"resolution"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Size <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"size"),a.autoesc),h+="</b>\n    </div>\n    <div>\n        Type <br />\n        <b>",h+=d.suppressValue(d.contextOrFrameLookup(b,c,"type"),a.autoesc),h+="</b>\n    </div>\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}(),function(){(window.nunjucksPrecompiled=window.nunjucksPrecompiled||{})["toolbar.button.html.njs"]=function(){function a(a,b,c,d,e){var f=null,g=null,h="";try{h+='<div id="t-button__',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"name",a.autoesc),a.autoesc),h+='" class="rs-toolbar-button ',""!=d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"css",a.autoesc)&&(h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"css",a.autoesc),a.autoesc)),h+='">\n    ',""!=d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc)?(h+='\n    <i class="',h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"icon",a.autoesc),a.autoesc),h+='"></i>\n    '):(h+="\n        ",h+=d.suppressValue(d.memberLookup(d.contextOrFrameLookup(b,c,"button"),"localizedName",a.autoesc),a.autoesc),h+="\n    "),h+="\n</div>",e(null,h)}catch(i){e(d.handleError(i,f,g))}}return{root:a}}()}();var Core;!function(a){var b=function(){function a(a){this.current=-1,this.image=a,this.actions=[],this.actionsResult=[]}return a.prototype.process=function(a){return this.actions.splice(this.current+1),this.actions.push(a),this.current++,this.actionsResult.splice(this.current),this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)},a.prototype.getUndoAction=function(){return this.current>=0?this.actions[this.current]:null},a.prototype.getRedoAction=function(){return this.current<this.actions.length-1?this.actions[this.current+1]:null},a.prototype.undo=function(){if(this.current>=0){var a=this.actions[this.current];return this.current--,this.actionsResult.push(this.doAction(a.unExecute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.redo=function(){if(this.current<this.actions.length-1){this.current++;var a=this.actions[this.current];return this.actionsResult.push(this.doAction(a.execute,a)),_.last(this.actionsResult)}return Promise.resolve(this.image)},a.prototype.doAction=function(a,b){var c=this;return 0==this.actionsResult.length?a.apply(b):new Promise(function(d){_.last(c.actionsResult).then(function(){a.apply(b).then(function(a){d(a)})})})},a}();a.ActionDispatcher=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b,c){this.imageName=b,this.imageType=c,this.id="",this.actionDispatcher=null,this.imageBase64="",this.image=null,this.caman=null,this.forceCamanUpdate=!1,this.isDeleted=!1,this.brightness=0,this.vibrance=0,this.hue=0,this.gamma=1,this.clip=0,this.stackBlur=0,this.contrast=0,this.saturation=0,this.exposure=0,this.sepia=0,this.noise=0,this.sharpen=0,this.channels={red:0,green:0,blue:0},this.filter=null,this.actionDispatcher=new a.ActionDispatcher(this)}return b.prototype.create=function(a){var b=this;return this.imageBase64=a,new Promise(function(a){b.createImagePromise(),b.getImage().then(function(c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=c.width,d.height=c.height,e.drawImage(c,0,0),b.originalImage=e.getImageData(0,0,c.width,c.height),b.imageBase64=d.toDataURL(b.imageType,.8),d.width=1,d.height=1,b.init(),a(b)})})},b.prototype.init=function(){this.processedImage=this.originalImage,this.width=this.originalImage.width,this.height=this.originalImage.height,this.brightness=0},b.prototype.getOriginalCoordinates=function(a,b){return{x:this.originalImage.width*a/this.processedImage.width|0,y:this.originalImage.height*b/this.processedImage.height|0}},b.prototype.getOriginalImage=function(){return this.originalImage},b.prototype.replaceOriginal=function(a){this.originalImage=a},b.prototype.crop=function(a,b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d");e.width=this.originalImage.width,e.height=this.originalImage.height,f.putImageData(this.originalImage,0,0);var g=this.getOriginalCoordinates(a,b),h=this.getOriginalCoordinates(c,d);this.originalImage=null,this.originalImage=f.getImageData(g.x,g.y,h.x,h.y),this.width=c,this.height=d,this.forceCamanUpdate=!0},b.prototype.getCaman=function(a,b){return void 0===b&&(b=!1),b||null==this.caman?new Promise(function(b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=a.width,c.height=a.height,d.putImageData(a,0,0),Caman(c,function(){b(this)})}):Promise.resolve(this.caman)},b.prototype.save=function(){var b=this,c=document.createElement("canvas"),d=c.getContext("2d");c.width=this.originalImage.width,c.height=this.originalImage.height,console.time("save"),d.putImageData(this.originalImage,0,0);var e,f=!1;return this.forceCamanUpdate&&(f=!0,this.forceCamanUpdate=!1),this.width!=this.processedImage.width&&this.height!=this.processedImage.height&&(f=!0),e=this.width!=this.originalImage.width||this.height!=this.originalImage.height?new a.ImageResizer(this.originalImage,this.width,this.height).resize():Promise.resolve(d.getImageData(0,0,this.width,this.height)),c.width=1,c.height=1,c=null,e.then(function(a){return b.getCaman(a,f)}).then(function(a){return b.caman=a,b.caman.revert(),b.caman.brightness(b.brightness),b.caman.vibrance(b.vibrance),b.caman.hue(b.hue),b.caman.gamma(b.gamma),b.caman.clip(b.clip),b.caman.stackBlur(b.stackBlur),b.caman.contrast(b.contrast),b.caman.saturation(b.saturation),b.caman.exposure(b.exposure),b.caman.sepia(b.sepia),b.caman.noise(b.noise),b.caman.sharpen(b.sharpen),b.caman.channels(_.extend({},b.channels)),null!==b.filter&&b.caman[b.filter.name].apply(b.caman,b.filter.parameters),new Promise(function(a){b.caman.render(function(){a(b.caman.imageData)})})}).then(function(a){var c=document.createElement("canvas"),d=c.getContext("2d");return b.processedImage=null,b.processedImage=a,c.width=b.processedImage.width,c.height=b.processedImage.height,d.putImageData(b.processedImage,0,0),b.imageBase64=c.toDataURL(b.imageType,.8),c.width=1,c.height=1,c=null,b.getImage().then(function(){b.createImagePromise()}),console.timeEnd("save"),b})},b.prototype.getSize=function(){return Math.round(atob(this.getImageBase64().substr(this.getImageBase64().indexOf(";base64")+8)).length/1e3)},b.prototype.getImageData=function(){return this.processedImage},b.prototype.getWidth=function(){return this.processedImage.width},b.prototype.getHeight=function(){return this.processedImage.height},b.prototype.getName=function(){return this.imageName},b.prototype.getLabel=function(){return""},b.prototype.getType=function(){return this.imageType},b.prototype.getImageBase64=function(){return this.imageBase64},b.prototype.getActionDispatcher=function(){return this.actionDispatcher},b.prototype.setId=function(a){this.id=a},b.prototype.getId=function(){return this.id},b.prototype.createImagePromise=function(){var a=this;this.imagePromise=new Promise(function(b){var c=new Image;c.onload=function(){null!=a.image&&(a.image.src="about:blank"),a.image=c,b(a.image)},c.src=a.imageBase64})},b.prototype.getImage=function(){return this.imagePromise},b}();a.RsImage=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a,b,c){this.original=a,this.newWidth=b,this.newHeight=c,this.size=this.original.data.length}return a.prototype.resize=function(){return this.picaResize()},a.prototype.picaResize=function(a){var b=this;return void 0===a&&(a=3),new Promise(function(c){pica.resizeBuffer({src:b.original.data,width:b.original.width,height:b.original.height,toWidth:b.newWidth,toHeight:b.newHeight,alpha:!0,quality:a},function(a,d){for(var e=document.createElement("canvas"),f=e.getContext("2d"),g=f.createImageData(b.newWidth,b.newHeight),h=0;h<d.length;h++)g.data[h]=d[h];e.width=1,e.height=1,c(g)})})},a}();a.ImageResizer=b}(Core||(Core={}));var Modules;!function(a){var b=function(){function a(a,b,c,d){this.image=a,this.red=b,this.green=c,this.blue=d,this.needRender=!1}return a.prototype.execute=function(){return this.oldValue=this.image.channels,this.image.channels={red:this.red,green:this.green,blue:this.blue},this.image.save()},a.prototype.unExecute=function(){return this.image.channels=this.oldValue,this.image.save()},a}();a.ChannelsAction=b}(Modules||(Modules={}));var Core;!function(a){!function(a){a[a.ACTION=0]="ACTION",a[a.DELEGATE=1]="DELEGATE",a[a.GROUP=2]="GROUP"}(a.ModuleType||(a.ModuleType={}));a.ModuleType}(Core||(Core={}));var Core;!function(a){var b=function(){function b(){this.images={},this.collections=[]}return b.prototype.newCollection=function(b){var c=new a.ImageCollection(this);for(var d in b)c.add(d);return this.collections.push(c),c},b.prototype.tryAdd=function(a){if(""==a.getId()){for(var b=Math.random().toString(36).substring(7);_.has(this.images,b);)b=Math.random().toString(36).substring(7);a.setId(b),this.add(a)}},b.prototype.add=function(a){this.images[a.getId()]=a},b.prototype.has=function(a){return _.has(this.images,a.getId())},b.prototype.remove=function(){},b}();a.ImageManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(a){this.manager=a,this.images=[]}return a.prototype.add=function(a){this.manager.tryAdd(a),this.images.push(a)},a.prototype.has=function(a){return this.images.indexOf(a)>-1},a.prototype.getResolutionStats=function(){var a={width:this.images[0].width,height:this.images[0].height},b={width:0,height:0};return this.images.forEach(function(c){c.isDeleted||(c.width*c.height<a.width*a.height&&(a.width=c.width,a.height=c.height),c.width*c.height>b.width*b.height&&(b.width=c.width,b.height=c.height))}),{min:a,max:b}},a.prototype.count=function(){return this.getImages().length},a.prototype.getAll=function(){return this.images},a.prototype.getNotSaved=function(){return this.getImages()},a.prototype.getImages=function(){var a=[];return this.images.forEach(function(b){b.isDeleted||a.push(b)}),a},a.prototype.getImage=function(b){var c=new a(this.manager);return this.images.forEach(function(a){a.isDeleted||a.getId()==b&&c.add(a)}),c},a.prototype.findImage=function(a){var b=[];return this.images.forEach(function(c){_.contains(a,c.getId())&&(c.isDeleted||b.push(c))}),b},a}();a.ImageCollection=b}(Core||(Core={}));var Core;!function(a){var b=function(){function a(){this.current=-1,this.actions=[]}return a.prototype.process=function(a){return this.actions.splice(this.current+1),this.actions.push(a),this.current++,a.execute()},a.prototype.undo=function(){if(this.current>=0){var a=this.actions[this.current];return this.current--,a.unExecute()}return!0},a.prototype.redo=function(){if(this.current<this.actions.length-1){this.current++;var a=this.actions[this.current];return a.execute()}return!0},a.prototype.canUndo=function(){return this.current>=0},a.prototype.canRedo=function(){return this.current<this.actions.length-1},a}();a.EditorActionDispatcher=b}(Core||(Core={}));var UI;!function(a){var b;!function(a){a[a.WIDTH=0]="WIDTH",a[a.HEIGHT=1]="HEIGHT",a[a.SOURCE=2]="SOURCE"}(b||(b={}));var c=function(){function a(a,b){this.page=a,this.image=b,this.needRefresh=!1,this.canvas=null,this.scale=1,this.scale=1,this.$loading=$('<div class="rs-singleView-loader" style="display: none"><i class="fa fa-cog fa-spin"></i> Rendering... </div>"')}return a.prototype.type=function(){return 0},a.prototype.getActualImage=function(){return[this.image]},a.prototype.update=function(){this.hideLoading(),this.needRefresh?this.render():(this.renderImage(),this.page.renderInformation(),$("#zoomValue").text(Math.floor(100*this.scale)+"%"))},a.prototype.setImages=function(a){if(1!=a.count())throw new Error("Invalid image collection");this.image=a.getImages()[0],this.scale=1},a.prototype.showLoading=function(){this.$loading.show()},a.prototype.hideLoading=function(){this.$loading.hide()},a.prototype.render=function(){var a=this;this.hideLoading(),this.page.getImagePlace().html(nunjucks.render("single.image.html.njs",{})),this.getCanvas(),this.renderImage(),this.setScale(this.scale);var b=$("body");b.off(".view"),b.on("click.view","#fitToWidth",function(){return a.setZoom(0),!1}),b.on("click.view","#sourceSize",function(){return a.setZoom(2),!1}),this.page.getImagePlace().find(".rs-single-image").append(this.$loading),this.needRefresh=!1},a.prototype.setZoom=function(a){var b=this.page.getImagePlace().find(".rs-single-image"),c=b.find("canvas"),d=1;0==a?(d=b.width()/c.width(),b.css("overflow","hidden")):2==a&&b.css("overflow","scroll"),this.setScale(d)},a.prototype.setScale=function(a){var b=this.page.getImagePlace().find(".rs-single-image"),c=b.find("canvas");b.scrollLeft(0),b.scrollTop(0),c.css("transform-origin","0 0"),c.css("transform","scale("+a+")"),this.scale=a,$("#zoomValue").text(Math.floor(100*a)+"%")},a.prototype.getScale=function(){return this.scale},a.prototype.selected=function(){return[this.image]},a.prototype.getAreaElement=function(){return this.page.getImagePlace().find("#rsSingleImage")},a.prototype.getInformation=function(){return nunjucks.render("single.information.html.njs",{resolution:this.image.width+"x"+this.image.height,size:this.image.getSize()+" kb",type:this.image.getType()})},a.prototype.renderImage=function(){this.canvas.width=this.image.getWidth(),this.canvas.height=this.image.getHeight(),this.context.putImageData(this.image.getImageData(),0,0)},a.prototype.getCanvas=function(){var a=this.page.getImagePlace().find("#"+this.image.getId());0==a.length&&this.page.getImagePlace().find("#rsSingleImage").html('<canvas id="'+this.image.getId()+'"></canvas>'),this.canvas=this.page.getImagePlace().find("#"+this.image.getId())[0],this.context=this.canvas.getContext("2d")},a}();a.SingleView=c}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.imageCollection=b,this.needRefresh=!1}return a.prototype.type=function(){return 1},a.prototype.getActualImage=function(){return this.selected()},a.prototype.render=function(){var a=this;this.page.getImagePlace().html("");var b=this.imageCollection.getImages();this.needRefresh=!1,b.forEach(function(b){a.renderImage(b)}),this.initSelectBlock(this.page.getInformationPlace().find("#rsSelect"))},a.prototype.setImages=function(a){this.imageCollection=a},a.prototype.getInformation=function(){if(this.imageCollection.count()>0){var a=this.imageCollection.getResolutionStats();return nunjucks.render("grid.information.html.njs",{count:this.imageCollection.count(),minResolution:a.min.width+"x"+a.min.height,maxResolution:a.max.width+"x"+a.max.height})}return""},a.prototype.selected=function(){var a=[];return this.page.getImagePlace().find(".rs-image-selected").each(function(b,c){a.push($(c).data("id"))}),this.imageCollection.findImage(a)},a.prototype.update=function(){var a=this;if(this.needRefresh)this.render();else{var b=this.imageCollection.getImages();b.forEach(function(b){a.updateImage(b)}),this.page.renderInformation(),this.initSelectBlock(this.page.getInformationPlace().find("#rsSelect"))}},a.prototype.showLoading=function(){this.page.getImagePlace().find(".rs-image-selected").find(".rs-image-block").addClass("loading")},a.prototype.hideLoading=function(){this.page.getImagePlace().find(".rs-image-selected").find(".rs-image-block").removeClass("loading")},a.prototype.initSelectBlock=function(a){var b=this;a.find("#rsSelectAll").click(function(c){return a.find(".rs-select__link").removeClass("selected"),b.selectImage(b.imageCollection.getImages()),$(c.target).addClass("selected"),!1}),a.find("#rsSelectNew").click(function(c){return a.find(".rs-select__link").removeClass("selected"),b.selectImage(b.imageCollection.getNotSaved()),$(c.target).addClass("selected"),!1}),a.find("#rsDeselectAll").click(function(){return a.find(".rs-select__link").removeClass("selected"),b.deselectAll(),b.page.renderToolbar(),!1})},a.prototype.selectImage=function(a){var b=this;this.deselectAll(),a.forEach(function(a){var c=b.page.getImagePlace().find("#img__"+a.getId());c.addClass("rs-image-selected"),c.find("input").prop("checked","true"),b.page.getEditor().selectImage(a)}),this.updateModule()},a.prototype.deselectAll=function(){var a=this.page.getImagePlace().find(".rs-image");a.removeClass("rs-image-selected"),a.find("input").removeAttr("checked"),this.updateModule()},a.prototype.updateModule=function(){this.page.getEditor().getActions().doModuleAction(function(a){a.update()},1)},a.prototype.updateImage=function(a){var b=this.page.getImagePlace().find("#img__"+a.getId());a.getImage().then(function(a){var c=b.find(".rs-image-block");b.find("img").remove(),c[0].appendChild(a),c.removeClass("loading")})},a.prototype.renderImage=function(a){var b=this;a.getImage().then(function(c){if(!a.isDeleted){var d=$(nunjucks.render("grid.image.html.njs",{image:{src:c,name:a.getName(),id:a.getId(),label:a.getLabel()}}));d.find(".rs-image-block")[0].appendChild(c),b.page.getImagePlace().append(d)}})},a}();a.GridView=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(a,b){this.page=a,this.editor=b,this.$toolbar=this.editor.getInterface().getToolbarPlace().find("#rsToolbarMainAction"),this.$editorToolbar=this.editor.getInterface().getToolbarPlace().find("#rsToolbarEditorAction")}return a.prototype.render=function(){this.$toolbar.html(""),this.$editorToolbar.html(""),null!==this.page.getParent()&&this.page.getParent().images().count()>1&&this.renderBackButton(this.$toolbar),this.renderCommonButton(this.$toolbar)},a.prototype.renderDelimiter=function(a){a.append($('<div class="t-delimeter"></div>'))},a.prototype.renderModuleToolbar=function(a,b,c){var d=this;void 0===c&&(c="");var e=this.editor.getEditor().getModuleManager().getModules(this.editor.getType(),null);e.forEach(function(a){var e=$(nunjucks.render("toolbar.button.html.njs",{button:{name:a.name(),icon:a.icon(),localizedName:a.name(),css:c}}));b.append(e),d.editor.initModule(e,a);

})},a.prototype.renderRemoveButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"remove",icon:"fa fa-remove",localizedName:"remove"}})))},a.prototype.renderCommonButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"upload",icon:"fa fa-upload",localizedName:"upload"}})))},a.prototype.renderUndoRedoButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"undo",icon:"fa fa-undo",localizedName:"undo"}}))),a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"redo",icon:"fa fa-repeat",localizedName:"redo"}})))},a.prototype.renderBackButton=function(a){a.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"back",icon:"fa fa-arrow-left",localizedName:"back"}})))},a}();a.Toolbar=b}(UI||(UI={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){if(a.prototype.render.call(this),this.renderDelimiter(this.$toolbar),this.editor.selected().length>0){var b=$('<div class="rs-toolbar-group"></div>');this.$toolbar.append(b),this.renderUndoRedoButton(b),this.renderDelimiter(b),this.renderModuleToolbar(1,b,"t-grid-button"),this.renderDelimiter(b),this.renderRemoveButton(b)}this.editor.getActionDispatcher().canUndo()&&this.$editorToolbar.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"undo-editor",icon:"fa fa-undo",localizedName:"undo-editor"}}))),this.editor.getActionDispatcher().canRedo()&&this.$editorToolbar.append($(nunjucks.render("toolbar.button.html.njs",{button:{name:"redo-editor",icon:"fa fa-repeat",localizedName:"redo-editor"}}))),this.editor.getInterface().initToolbar(this.$toolbar),this.editor.getInterface().initEditorToolbar(this.$editorToolbar)},b}(a.Toolbar);a.GridToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(a){function b(b,c){a.call(this,b,c)}return __extends(b,a),b.prototype.render=function(){a.prototype.render.call(this),this.renderDelimiter(this.$toolbar),this.renderUndoRedoButton(this.$toolbar);var b=$('<div class="rs-toolbar-group"></div>');this.$toolbar.append(b),this.renderModuleToolbar(0,b,"t-grid-button"),this.renderRemoveButton(b),this.editor.getInterface().initToolbar(this.$toolbar),this.editor.getInterface().initEditorToolbar(this.$editorToolbar)},b}(a.Toolbar);a.SingleToolbar=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(a,b,c){void 0===c&&(c=null),this.editor=a,this.imageCollection=b,this.parent=c,this.view=null}return b.prototype.hasParent=function(){return null!=this.parent},b.prototype.getParent=function(){return this.parent},b.prototype.setImages=function(a){this.imageCollection=a,this.getView().setImages(this.imageCollection)},b.prototype.appendImage=function(a){this.imageCollection.add(a)},b.prototype.images=function(){return this.imageCollection},b.prototype.getView=function(){return null!=this.view?this.view:(this.view=1==this.imageCollection.getImages().length?new a.SingleView(this,this.imageCollection.getImages()[0]):new a.GridView(this,this.imageCollection),this.view)},b.prototype.getToolbar=function(){return 1==this.imageCollection.getImages().length?new a.SingleToolbar(this,this.editor):new a.GridToolbar(this,this.editor)},b.prototype.renderInformation=function(){var a=this.getView().getInformation();""!=a?(this.getInformationPlace().parent().show(),this.getInformationPlace().html(a)):this.getInformationPlace().parent().hide()},b.prototype.renderToolbar=function(){this.getToolbar().render()},b.prototype.render=function(){this.renderToolbar(),this.getImagePlace().html(""),this.renderInformation(),this.getView().render()},b.prototype.getImagePlace=function(){return this.editor.getInterface().getImagePlace()},b.prototype.getInformationPlace=function(){return this.editor.getInterface().getInformationPlace()},b.prototype.getEditor=function(){return this.editor},b}();a.Page=b}(UI||(UI={}));var UI;!function(a){var b=function(){function a(){}return a.init=function(a,b,c){return 0==b.type()?this.initAction(a,b,c):1==b.type()?this.initDelegate(a,b,c):alert("GROUP!!!"),b},a.initAction=function(a,b){a.click(function(){b.process()})},a.initDelegate=function(a,b,c){var d=this;a.click(function(){$(".rs-toolbar-button").removeClass("active"),a.addClass("active"),d.renderModule(b,c)})},a.renderModule=function(a,b){return null!=b.getActiveModule()&&b.getActiveModule().deinit(),a.init(b.getInterface().showPopover(a.html())),b.setActiveModule(a),!1},a}();a.ModuleInitialization=b}(UI||(UI={}));var UI;!function(a){var b;!function(a){var b=function(){function a(){this.events={}}return a.prototype.on=function(a,b,c){return void 0===c&&(c="_"),_.has(this.events,a)||(this.events[a]={}),_.has(this.events[a],c)||(this.events[a][c]=[]),this.events[a][c].push(b),this},a.prototype.off=function(a){var b=this;void 0===a&&(a="_"),_.map(this.events,function(c,d){b.events[d]=_.omit(c,a)})},a.prototype.trigger=function(a,b){var c=this;void 0===b&&(b=null),_.has(this.events,a)&&_.map(this.events[a],function(a){a.forEach(function(a){a({data:b,widget:c})})})},a}();a.RsWidget=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b){a.call(this),this.$el=b,this.$label=$('<div class="rs-progress-label"></div>'),this.$line=$('<div class="rs-progress-line"></div>'),this.$el.html(""),this.$el.append(this.$label),this.$el.append(this.$line)}return __extends(b,a),b.prototype.getOpCount=function(){return this.opCount},b.prototype.start=function(a,b){this.opCount=b,this.setProgress(0,a),this.trigger("start"),this.$el.show()},b.prototype.setProgress=function(a,b){this.$label.text(b),this.$line.css("width",a/this.opCount*100+"%"),a>=this.opCount?this.trigger("stop"):this.trigger("progress",a)},b.prototype.stop=function(a){var b=this;this.$label.text(a),setTimeout(function(){b.$el.hide()},200)},b}(a.RsWidget);a.RsProgressBar=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var UI;!function(a){var b=function(){function b(b,c){var d=this;this.$el=b,this.controller=c,this.$el.html(nunjucks.render("editor.html.njs",{}));var e=this.$el.find("#rsFileInput");e.on("change",function(){c.getEditor().getLoader().load(this.files)}),this.$el.on("click","#t-button__upload",function(){return e.trigger("click"),!1}),this.$el.on("click",".rs-image-block, .rs-image-data__inf",function(a){d.editImage($(a.target).closest(".rs-image").data("id"))}),this.$el.on("click","#t-button__back",function(){return d.controller.back(),!1}),this.$el.on("click",".rs-image-selection-checkbox",function(a){d.selectImage($(a.target).closest(".rs-image"))}),this.$popOver=this.$el.find("#rsPopover"),this.$toolbarPlace=this.$el.find("#rsToolbarPlace"),this.$imagePlace=this.$el.find("#rsImagePlace"),this.$informationPlace=this.$el.find("#rsInformation"),this.progressBar=new a.Widgets.RsProgressBar(this.$el.find("#rsProgressBar")),this.progressBar.on("stop",function(){d.progressBar.stop("Loading complete!")})}return b.prototype.showProgressBar=function(a){this.progressBar.start("Loading image...",a)},b.prototype.progress=function(a){this.progressBar.setProgress(a,"Image "+a+" from "+this.progressBar.getOpCount())},b.prototype.showPopover=function(a){return this.$popOver.html(a),this.$popOver.show(),this.$popOver},b.prototype.clearPopover=function(){this.$popOver.html(""),this.$popOver.hide()},b.prototype.getImagePlace=function(){return this.$imagePlace},b.prototype.getToolbarPlace=function(){return this.$toolbarPlace},b.prototype.getInformationPlace=function(){return this.$informationPlace},b.prototype.initToolbar=function(a){var b=this;null!=this.controller.getActiveModule()&&a.find("#t-button__"+this.controller.getActiveModule().name()).addClass("active"),a.find("#t-button__redo").click(function(){return b.controller.getActions().imageRedo(),!1}),a.find("#t-button__undo").click(function(){return b.controller.getActions().imageUndo(),!1}),a.find("#t-button__remove").click(function(){return b.controller.getActions().removeSelected(),!1})},b.prototype.initEditorToolbar=function(a){var b=this;a.find("#t-button__redo-editor").click(function(){return b.controller.getActions().redo(),!1}),a.find("#t-button__undo-editor").click(function(){return b.controller.getActions().undo(),!1})},b.prototype.editImage=function(a){this.controller.openImageEditor(this.controller.getImages().getImage(a))},b.prototype.selectImage=function(a){var b=this.controller.getImages().getImage(a.data("id")).getImages()[0];a.hasClass("rs-image-selected")?(a.removeClass("rs-image-selected"),this.controller.unSelectImage(b)):(a.addClass("rs-image-selected"),this.controller.selectImage(b))},b}();a.EditorView=b}(UI||(UI={}));var EditorAction;!function(a){var b=function(){function a(a,b){this.editor=a,this.images=b}return a.prototype.execute=function(){return this.images.forEach(function(a){a.isDeleted=!0}),!0},a.prototype.unExecute=function(){return this.images.forEach(function(a){a.isDeleted=!1}),!0},a}();a.RemoveAction=b}(EditorAction||(EditorAction={}));var UI;!function(a){var b=function(){function a(a){this.controller=a}return a.prototype.imageUndo=function(){this.imageHistoryAction("Undo")},a.prototype.imageRedo=function(){this.imageHistoryAction("Redo")},a.prototype.redo=function(){this.controller.getActionDispatcher().redo(),this.controller.render()},a.prototype.undo=function(){this.controller.getActionDispatcher().undo(),this.controller.render()},a.prototype.removeSelected=function(){var a=new EditorAction.RemoveAction(this.controller,this.getView().selected());this.controller.getActionDispatcher().process(a),0==this.controller.getType()?this.controller.back():this.controller.render()},a.prototype.doModuleAction=function(a,b){if(void 0===b&&(b=2),null!=this.controller.getActiveModule()){var c=this.controller.getActiveModule();(c.viewType()==b||2==c.viewType())&&a.call(this.controller,c)}},a.prototype.getView=function(){return this.controller.getView()},a.prototype.imageHistoryAction=function(a){var b=this,c=[];this.getView().showLoading(),this.getView().getActualImage().forEach(function(d){var e=d.getActionDispatcher()["get"+a+"Action"]();e&&e.needRender&&(b.getView().needRefresh=!0),c.push(d.getActionDispatcher()[a.toLowerCase()]())}),Promise.all(c).then(function(){b.getView().update(),b.doModuleAction(function(a){a.update()},b.controller.getType())})},a}();a.EditorActions=b}(UI||(UI={}));var UI;!function(a){var b=function(){function b(b,c,d){this.$el=b,this.editor=c,this.images=d,this.page=null,this.gridPage=null,this.singlePage=null,this.activeModule=null,this.editorView=new a.EditorView(b,this),this.editorAction=new a.EditorActions(this),this.gridPage=new a.Page(this,this.images),this.singlePage=new a.Page(this,this.images,this.gridPage),this.actionController=new Core.EditorActionDispatcher}return b.prototype.getActionDispatcher=function(){return this.actionController},b.prototype.getInterface=function(){return this.editorView},b.prototype.getActions=function(){return this.editorAction},b.prototype.initModule=function(b,c){a.ModuleInitialization.init(b,c,this)},b.prototype.getActiveModule=function(){return this.activeModule},b.prototype.setActiveModule=function(a){this.activeModule=a},b.prototype.getView=function(){return this.getPage().getView()},b.prototype.back=function(){this.page.hasParent()&&(this.page=this.page.getParent(),this.render())},b.prototype.selected=function(){return this.getPage().getView().selected()},b.prototype.getEditor=function(){return this.editor},b.prototype.getPage=function(){return null==this.page&&(this.page=1==this.images.count()?this.singlePage:this.gridPage),this.page},b.prototype.getType=function(){return this.getPage().getView().type()},b.prototype.render=function(){var b=this;null!=this.activeModule&&this.activeModule.deinit(),this.getPage().render(),this.getActions().doModuleAction(function(){a.ModuleInitialization.renderModule(b.activeModule,b)},this.getType())},b.prototype.appendImage=function(a){this.gridPage.appendImage(a),1==this.images.count()?(this.singlePage.setImages(this.images.getImage(this.images.getImages()[0].getId())),this.page=this.singlePage):this.page=this.gridPage},b.prototype.openImageEditor=function(a){this.singlePage.setImages(a),this.page=this.singlePage,this.render()},b.prototype.getImages=function(){return this.images},b.prototype.unSelectImage=function(a){var b=this;this.page.renderToolbar(),this.getActions().doModuleAction(function(){b.activeModule.unSelectImage(a)},this.getType())},b.prototype.selectImage=function(a){var b=this;this.page.renderToolbar(),this.getActions().doModuleAction(function(){b.activeModule.selectImage(a)},this.getType())},b}();a.Editor=b}(UI||(UI={}));var Core;!function(a){!function(a){a[a.SINGLE=0]="SINGLE",a[a.GRID=1]="GRID",a[a.ANY=2]="ANY"}(a.ModuleViewType||(a.ModuleViewType={}));var b=(a.ModuleViewType,function(){function a(a){this.editor=a,this.modules={},this.registerModule("resize",new Modules.ResizeModule(this.editor.UI()),0),this.registerModule("image",new Modules.ImageModule(this.editor.UI()),2),this.registerModule("color",new Modules.ColorModule(this.editor.UI()),2),this.registerModule("filter",new Modules.FilterModule(this.editor.UI()),2),this.registerModule("crop",new Modules.CropModule(this.editor.UI()),0),this.registerModule("crop-resize",new Modules.CropResizeModule(this.editor.UI()),1)}return a.prototype.registerModule=function(a,b,c){a in this.modules||(this.modules[a]={module:b,type:c})},a.prototype.getModule=function(a){if(a in this.modules)return this.modules[a].module;throw new Error("Invalid module name")},a.prototype.getModules=function(a,b){return void 0===a&&(a=2),void 0===b&&(b=null),_.map(_.filter(this.modules,function(c){return c.type!=a&&2!=a&&2!=c.type||c.module.parent()!=b?!1:!0}),function(a){return a.module})},a}());a.ModuleManager=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(a){this.editor=a,this.total=0,this.total=0}return b.prototype.load=function(a){var b=this,c=0;this.total=0,this.editor.UI().getInterface().showProgressBar(a.length);var d=new Promise(function(d){var e=setInterval(function(){if(c<a.length){var f=!1;c==a.length-1&&(f=!0),b.loadFile(a[c],d,f),c++}else clearInterval(e)},100)});d.then(function(){b.editor.UI().render()})},b.prototype.loadFile=function(b,c,d){var e=this;if(!b.type.match(/image.*/))return!1;var f=new FileReader;f.onload=function(f){var g=new a.RsImage(b.name,b.type);g.create(f.target.result).then(function(a){e.editor.appendImage(a),e.total++,e.editor.UI().getInterface().progress(e.total),d&&c(1)})},f.readAsDataURL(b)},b}();a.ImageLoader=b}(Core||(Core={}));var Core;!function(a){var b=function(){function b(b){this.imageManager=new a.ImageManager,this.ui=new UI.Editor(b,this,this.imageManager.newCollection([])),this.moduleManager=new a.ModuleManager(this),this.loader=new a.ImageLoader(this),this.ui.render()}return b.prototype.UI=function(){return this.ui},b.prototype.getModuleManager=function(){return this.moduleManager},b.prototype.appendImage=function(a){this.ui.appendImage(a)},b.prototype.getLoader=function(){return this.loader},b.prototype.getImageManager=function(){return this.imageManager},b}();a.RsImageEditor=b}(Core||(Core={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f){var g=this;void 0===e&&(e=1),void 0===f&&(f=0),a.call(this),this.$el=b,this.min=c,this.max=d,this.step=e,this.start=f,this.$slider=$('<div class="rs-slider-handle"></div>'),this.$el.html(""),this.$el.addClass("rs-slider"),this.$el.append(this.$slider),this.$slider.css("left",this.getPixelPos(this.start)+"px");var h=$(document);this.$slider.mousedown(function(a){var b=a.clientX-parseInt(g.$slider.css("left"));h.off(".RsSlider"),h.on("mousemove.RsSlider",function(a){var c=a.clientX-b;0>c&&(c=0);var d=g.$el.width()-g.$slider.width();c>d&&(c=d),g.$slider.css("left",c+"px"),g.trigger("move",Math.round(10*g.getVal(c))/10)}),h.on("mouseup.RsSlider",function(){var a=parseInt(g.$slider.css("left"));g.trigger("stopmove",g.getVal(a)),h.off(".RsSlider")})}),this.on("move",function(a){g.$slider.text(a.data)}),this.trigger("move",this.start)}return __extends(b,a),b.prototype.getElement=function(){return this.$el},b.prototype.set=function(a,b){void 0===b&&(b=""),this.$slider.css("left",this.getPixelPos(a)+"px"),this.$slider.text(""==b?a.toString():b)},b.prototype.getVal=function(a){return Math.round(a*((this.max-this.min)/this.step)/(this.$el.width()-this.$slider.width()))*this.step+this.min},b.prototype.getPixelPos=function(a){return(a-this.min)/this.step*(this.$el.width()-this.$slider.width())/((this.max-this.min)/this.step)},b}(a.RsWidget);a.RsSlider=b}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.sliders={},this.channels={red:0,green:0,blue:0}}return b.prototype.html=function(){return nunjucks.render("color.html.njs",{})},b.prototype.viewType=function(){return 2},b.prototype.unSelectImage=function(){this.update()},b.prototype.selectImage=function(){this.update()},b.prototype.update=function(){var a=this.editor.selected();1==a.length?this.updateSlidersByImage(a[0]):a.length>0?this.updateSliders(a):this.setSlidersValue(0,"-")},b.prototype.updateSlidersByImage=function(a){_.map(this.sliders,function(b,c){b.set(a.channels[c])})},b.prototype.setSlidersValue=function(a,b){void 0===b&&(b=""),_.map(this.sliders,function(c){c.set(a,b)})},b.prototype.updateSliders=function(a){_.map(this.sliders,function(b,c){var d=a[0].channels[c];b.set(d);for(var e=0;e<a.length;e++)if(d!=a[e].channels[c])return void b.set(0,"-")})},b.prototype.init=function(a){var b=this;a.find(".m__color-slider").each(function(a,c){var d=$(c);b.sliders[d.data("name")]=new UI.Widgets.RsSlider(d,d.data("min"),d.data("max"),d.data("step")).on("stopmove",function(a){var c=a.widget.getElement().data("name");b.channels[c]=a.data,b.doAction()})}),this.update()},b.prototype.deinit=function(){this.editor.getInterface().clearPopover()},b.prototype.icon=function(){return"fa fa-stumbleupon-circle"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"color"},b.prototype.doAction=function(){var b=this;this.editor.getView().showLoading();var c=[];this.editor.selected().forEach(function(d){var e=new a.ChannelsAction(d,b.channels.red,b.channels.green,b.channels.blue);c.push(d.getActionDispatcher().process(e))}),Promise.all(c).then(function(){b.editor.getView().update()})},b}();a.ColorModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c,d,e,f){void 0===f&&(f=null),this.image=a,this.left=b,this.top=c,this.width=d,this.height=e,this.position=f,this.needRender=!1}return a.prototype.execute=function(){this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.originalImage=this.image.getOriginalImage();var a=this.left,b=this.top;return null!=this.position&&(1==this.position||7==this.position||4==this.position?a=(this.image.width-this.width)/2:(2==this.position||5==this.position||8==this.position)&&(a=this.image.width-this.width),3==this.position||5==this.position||4==this.position?b=(this.image.height-this.height)/2:(6==this.position||7==this.position||8==this.position)&&(b=this.image.height-this.height)),this.image.crop(a,b,this.width,this.height),this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.replaceOriginal(this.originalImage),this.image.save()},a}();a.CropAction=b}(Modules||(Modules={}));var UI;!function(a){var b;!function(a){var b=function(a){function b(b,c,d){a.call(this),this.$el=b,this.$parent=c,this.index=d,this.itemHalfSize=5,this.init()}return __extends(b,a),b.prototype.getElementCorners=function(){var a={x:this.$el.position().left,y:this.$el.position().top},b={x:a.x+this.$el.width(),y:a.y},c={x:a.x+this.$el.width(),y:a.y+this.$el.height()},d={x:a.x,y:a.y+this.$el.height()};return{topLeft:a,topRight:b,bottomRight:c,bottomLeft:d}},b.prototype.getPosition=function(){return this.position},b.prototype.getIndex=function(){return this.index},b.prototype.toPlace=function(){var a,b=this.getElementCorners();0==this.index?a=b.topLeft:1==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.topRight.y}:2==this.index?a=b.topRight:3==this.index?a={x:b.topRight.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}:4==this.index?a=b.bottomRight:5==this.index?a={x:b.topLeft.x+(b.topRight.x-b.topLeft.x)/2,y:b.bottomRight.y}:6==this.index?a=b.bottomLeft:7==this.index&&(a={x:b.topLeft.x,y:b.topRight.y+(b.bottomRight.y-b.topRight.y)/2}),this.position=a,this.$item.css({left:a.x-this.itemHalfSize+"px",top:a.y-this.itemHalfSize+"px"})},b.prototype.init=function(){var a=this;this.$item=$('<div class="rs-resizable-item item_'+this.index+'"></div>'),this.$parent.append(this.$item),this.toPlace();var b=$(document);this.$item.mousedown(function(c){var d=c.clientX-parseInt(a.$item.css("left"))-a.itemHalfSize,e=c.clientY-parseInt(a.$item.css("top"))-a.itemHalfSize;b.on("mousemove.RsResize_"+a.index,function(b){var c={x:b.clientX-d,y:b.clientY-e};a.moveItem(c),a.trigger("move",{index:a.index,newPosition:a.position,oldPosition:{x:d,y:e}})}),b.on("mouseup.RsResize_"+a.index,function(){b.off(".RsResize_"+a.index)})})},b.prototype.moveItem=function(a){var b=this.getElementCorners();(0==this.index||7==this.index||6==this.index)&&a.x>=b.topRight.x-10&&(a.x=b.topRight.x-10),(0==this.index||1==this.index||2==this.index)&&a.y>=b.bottomRight.y-10&&(a.y=b.bottomRight.y-10),this.$item.css(1==this.index||5==this.index?{top:a.y-5+"px"}:7==this.index||3==this.index?{left:a.x-5+"px"}:{left:a.x-5+"px",top:a.y-5+"px"}),this.position={x:parseInt(this.$item.css("left"))+5,y:parseInt(this.$item.css("top"))+5}},b}(a.RsWidget),c=function(a){function c(c,d){var e=this;a.call(this),this.$el=c,this.$parent=d,this.items=[],this.$el.addClass("rs-resizable");for(var f=0;8>f;f++){var g=new b(this.$el,this.$parent,f);this.items.push(g),g.on("move",function(a){e.onItemMove(a.data.index,a.data.newPosition,a.data.oldPosition)})}var h=$(document);this.$el.mousedown(function(a){var b=a.clientX-parseInt(e.$el.css("left")),c=a.clientY-parseInt(e.$el.css("top"));h.on("mousemove.RsResize",function(a){var d={x:a.clientX-b,y:a.clientY-c};e.$el.css({left:d.x,top:d.y}),e.updateItems()}),h.on("mouseup.RsResize",function(){h.off(".RsResize")})})}return __extends(c,a),c.prototype.onItemMove=function(a,b){0==a?(this.$el.css({left:b.x+"px",top:b.y+"px",width:this.items[4].getPosition().x-b.x+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):1==a?(this.$el.css({top:b.y+"px",height:this.items[4].getPosition().y-b.y+"px"}),this.updateItems([4])):2==a?(this.$el.css({right:b.x+"px",top:b.y+"px",width:b.x-this.items[6].getPosition().x+"px",height:this.items[6].getPosition().y-b.y+"px"}),this.updateItems([6])):3==a?(this.$el.css({right:b.x+"px",width:b.x-this.items[6].getPosition().x+"px"}),this.updateItems([6])):4==a?(this.$el.css({right:b.x+"px",bottom:b.y+"px",width:b.x-this.items[0].getPosition().x+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):5==a?(this.$el.css({bottom:b.y+"px",height:b.y-this.items[0].getPosition().y+"px"}),this.updateItems([0])):6==a?(this.$el.css({left:b.x+"px",bottom:b.y+"px",width:this.items[2].getPosition().x-b.x+"px",height:b.y-this.items[2].getPosition().y+"px"}),this.updateItems([2])):7==a&&(this.$el.css({left:b.x+"px",width:this.items[2].getPosition().x-b.x+"px"}),this.updateItems([2]))},c.prototype.getBounds=function(){return{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}},c.prototype.updateItems=function(a){void 0===a&&(a=[]),this.trigger("resize",{width:this.$el.width(),height:this.$el.height(),left:this.items[0].getPosition().x,top:this.items[0].getPosition().y}),this.items.forEach(function(b){_.contains(a,b.getIndex())||b.toPlace()})},c}(a.RsWidget);a.RsResizable=c}(b=a.Widgets||(a.Widgets={}))}(UI||(UI={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.view=null}return b.prototype.html=function(){return nunjucks.render("crop.dialog.html.njs",{})},b.prototype.selectImage=function(){},b.prototype.unSelectImage=function(){},b.prototype.update=function(){},b.prototype.deinit=function(){this.editor.getInterface().clearPopover(),null!=this.view&&(this.$cropRect.remove(),this.view.getAreaElement().find(".rs-resizable-item").remove())},b.prototype.viewType=function(){return 0},b.prototype.init=function(){var a=this;this.view=this.editor.getView(),this.$cropRect=$('<div class="crop-rect"></div>'),this.view.getAreaElement().append(this.$cropRect),this.cropResizableWidget=new UI.Widgets.RsResizable(this.$cropRect,this.view.getAreaElement()),$("#crop_ok").click(function(){var b=a.cropResizableWidget.getBounds(),c=Math.round(b.width/a.view.getScale());a.doAction(b.left/a.view.getScale(),b.top/a.view.getScale(),c,b.height/a.view.getScale())})},b.prototype.icon=function(){return"fa fa-crop"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"crop"},b.prototype.doAction=function(b,c,d,e){var f=this,g=[];this.editor.selected().forEach(function(f){var h=new a.CropAction(f,b,c,d,e);g.push(f.getActionDispatcher().process(h))}),Promise.all(g).then(function(){f.editor.render()})},b}();a.CropModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.images=[],this.fit=null,this.crop=null}return b.prototype.init=function(a){this.view=this.editor.getView(),this.$el=a,this.update()},b.prototype.deleteHelpers=function(){null!=this.fit&&(this.fit.destroy(),this.fit=null),null!=this.crop&&(this.crop.destroy(),this.crop=null)},b.prototype.initFit=function(){var b=this;this.fit=new a.Fit(this.$el,this.images,this.editor),this.fit.on("apply",function(a){b.doAction(b.createFitActions(a.data.rect,a.data.method,a.data.fitPosition,a.data.isCanCrop))})},b.prototype.initCrop=function(){var b=this;this.crop=new a.Crop(this.$el,this.images,this.editor),this.crop.on("apply",function(a){b.doAction(b.createCropActions(a.data.size,a.data.fitPosition))})},b.prototype.update=function(){this.deleteHelpers(),this.images=this.editor.selected(),this.images.length>0?(this.$el.show(),this.initFit(),this.initCrop()):this.$el.hide()},b.prototype.createCropActions=function(b,c){this.editor.getView().showLoading();var d=[];return this.editor.selected().forEach(function(e){var f=new a.CropAction(e,0,0,b.width,b.height,c);d.push(e.getActionDispatcher().process(f))}),d},b.prototype.createFitActions=function(b,c,d,e){this.editor.getView().showLoading();var f=[];return this.editor.selected().forEach(function(g){var h=new a.FitAction(g,b,c,d,e);f.push(g.getActionDispatcher().process(h))}),f},b.prototype.doAction=function(a){var b=this;Promise.all(a).then(function(){b.editor.getView().update()})},b.prototype.html=function(){return nunjucks.render("crop-resize.dialog.html.njs",{})},b.prototype.selectImage=function(){this.update()},b.prototype.unSelectImage=function(){this.update()},b.prototype.viewType=function(){return 1},b.prototype.icon=function(){return"fa fa-crop"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"crop-resize"},b.prototype.deinit=function(){this.deleteHelpers(),this.editor.getInterface().clearPopover()},b}();a.CropResizeModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(b,c,d,e,f){this.image=b,this.rect=c,this.method=d,this.position=e,this.isCanCrop=f,this.needRender=!1,this.isCropped=!1,this.size=0==d?a.SizeCalculation.getFitSize(c.width,c.height,this.image.width,this.image.height):1==d?a.SizeCalculation.getStretchWidthSize(c.width,c.height,this.image.width,this.image.height):2==d?a.SizeCalculation.getStretchHeightSize(c.width,c.height,this.image.width,this.image.height):a.SizeCalculation.getStretchRectSize(c.width,c.height,this.image.width,this.image.height)}return b.prototype.execute=function(){var a=this;return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),(this.size.width>this.rect.width||this.size.height>this.rect.height)&&(this.originalImage=this.image.getOriginalImage(),this.isCropped=!0),this.image.width=0|this.size.width,this.image.height=0|this.size.height,this.image.save().then(function(b){if(a.isCropped&&a.isCanCrop){var c=0,d=0,e=a.image.width;e>a.rect.width&&(e=a.rect.width,1==a.position||7==a.position?c=(a.image.width-a.rect.width)/2:(2==a.position||5==a.position||8==a.position)&&(c=a.image.width-a.rect.width));var f=a.image.height;return f>a.rect.height&&(f=a.rect.height,3==a.position||5==a.position?d=(a.image.height-a.rect.height)/2:(6==a.position||7==a.position||8==a.position)&&(d=a.image.height-a.rect.height)),a.image.getImage().then(function(){return a.image.crop(c,d,e,f),a.image.save()})}return Promise.resolve(b)})},b.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.isCropped&&this.isCanCrop&&this.image.replaceOriginal(this.originalImage),this.image.save()},b}();a.FitAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(a){function b(b,c,d){var e=this;a.call(this),this.$el=b,this.images=c,this.ui=d,this.$widthInput=b.find(".crop__width input"),this.$heightInput=b.find(".crop__height input"),this.$widthInput.val(this.images[0].width.toString()),this.$heightInput.val(this.images[0].height.toString()),this.$position=b.find("#cropPosition .fp"),this.$button=b.find("#cropButton"),this.$button.on("click.CropResize",function(){return e.isSizeValid(e.getRectSize())&&e.trigger("apply",{fitPosition:e.getPosition(),size:e.getRectSize()}),!1}),this.$position.on("click.CropResize",function(a){e.$position.removeClass("selected"),e.selectPosition($(a.target))}),this.$widthInput.on("input.CropResize",function(){}),this.$heightInput.on("input.CropResize",function(){})}return __extends(b,a),b.prototype.isSizeValid=function(a){return!(a.width<30&&a.width>9999||a.height<30&&a.height>9999)},b.prototype.selectPosition=function(a){a.addClass("selected")},b.prototype.getPosition=function(){var a=this.$position.filter(".selected");if(a){if(a.hasClass("fp-left-top"))return 0;if(a.hasClass("fp-top"))return 1;if(a.hasClass("fp-right-top"))return 2;if(a.hasClass("fp-left"))return 3;if(a.hasClass("fp-center"))return 4;if(a.hasClass("fp-right"))return 5;if(a.hasClass("fp-left-bottom"))return 6;if(a.hasClass("fp-bottom"))return 7;if(a.hasClass("fp-right-bottom"))return 8}return null},b.prototype.getRectSize=function(){return{width:parseInt(this.$widthInput.val()),height:parseInt(this.$heightInput.val())}},b.prototype.destroy=function(){this.$button.off(".CropResize"),this.$position.off(".CropResize"),this.$widthInput.off(".CropResize"),this.$heightInput.off(".CropResize")},b}(UI.Widgets.RsWidget);a.Crop=b}(Modules||(Modules={}));var Modules;!function(a){!function(a){a[a.RESIZE=0]="RESIZE",a[a.WIDTH=1]="WIDTH",a[a.HEIGHT=2]="HEIGHT",a[a.RECT=3]="RECT"}(a.FitMethod||(a.FitMethod={}));a.FitMethod;!function(a){a[a.LEFT_TOP=0]="LEFT_TOP",a[a.TOP=1]="TOP",a[a.RIGHT_TOP=2]="RIGHT_TOP",a[a.LEFT=3]="LEFT",a[a.CENTER=4]="CENTER",a[a.RIGHT=5]="RIGHT",a[a.LEFT_BOTTOM=6]="LEFT_BOTTOM",a[a.BOTTOM=7]="BOTTOM",a[a.RIGHT_BOTTOM=8]="RIGHT_BOTTOM"}(a.FitPosition||(a.FitPosition={}));var b=(a.FitPosition,function(b){function c(c,d,e){var f=this;b.call(this),this.$el=c,this.images=d,this.ui=e,this.selected=0,this.fitCanvas=new a.FitMethodCanvas(c.find("#fitCanvas")[0]),this.$widthInput=c.find(".sizes__width input"),this.$heightInput=c.find(".sizes__height input"),this.$widthInput.val(this.images[0].width.toString()),this.$heightInput.val(this.images[0].height.toString()),this.$position=c.find("#fitPosition .fp"),
this.$button=c.find(".fit-button"),this.$methods=c.find(".module-list li"),this.$methods.on("click.CropResize",function(a){f.$methods.removeClass("selected"),f.selectMethod($(a.target))}),this.$button.on("click.CropResize",function(){return f.isSizeValid(f.getRectSize())&&f.trigger("apply",{method:f.selected,fitPosition:f.getPosition(),rect:f.getRect(),isCanCrop:c.find("#fitCrop").is(":checked")}),!1}),this.$position.on("click.CropResize",function(a){f.$position.removeClass("selected"),f.selectPosition($(a.target))}),this.$widthInput.on("input.CropResize",function(){f.update()}),this.$heightInput.on("input.CropResize",function(){f.update()}),this.$methods.removeClass("selected"),this.selectMethod(this.$methods.eq(0)),this.update()}return __extends(c,b),c.prototype.update=function(){var a=this.getRectSize();this.isSizeValid(a)&&this.updateCanvas()},c.prototype.isSizeValid=function(a){return!(a.width<30&&a.width>9999||a.height<30&&a.height>9999)},c.prototype.selectPosition=function(a){a.addClass("selected"),this.updateCanvas()},c.prototype.getPosition=function(){var a=this.$position.filter(".selected");if(a){if(a.hasClass("fp-left-top"))return 0;if(a.hasClass("fp-top"))return 1;if(a.hasClass("fp-right-top"))return 2;if(a.hasClass("fp-left"))return 3;if(a.hasClass("fp-center"))return 4;if(a.hasClass("fp-right"))return 5;if(a.hasClass("fp-left-bottom"))return 6;if(a.hasClass("fp-bottom"))return 7;if(a.hasClass("fp-right-bottom"))return 8}return null},c.prototype.getSelectedMethod=function(){return this.selected},c.prototype.getRect=function(){return{left:0,top:0,width:parseInt(this.$widthInput.val()),height:parseInt(this.$heightInput.val())}},c.prototype.getRectSize=function(){return{width:parseInt(this.$widthInput.val()),height:parseInt(this.$heightInput.val())}},c.prototype.selectMethod=function(a){this.images=this.ui.selected(),a.addClass("selected"),"resize-all"==a.data("value")?this.selected=0:"stretch-to-width"==a.data("value")?this.selected=1:"stretch-to-height"==a.data("value")?this.selected=2:"stretch-to-rect"==a.data("value")&&(this.selected=3),this.updateCanvas()},c.prototype.updateCanvas=function(){var a=this.getRectSize();0==this.selected?this.fitCanvas.drawResizeAll(a.width,a.height,this.images[0].getWidth(),this.images[0].getHeight(),this.getPosition()):1==this.selected?this.fitCanvas.drawStretchToWidth(a.width,a.height,this.images[0].getWidth(),this.images[0].getHeight(),this.getPosition()):2==this.selected?this.fitCanvas.drawStretchToHeight(a.width,a.height,this.images[0].getWidth(),this.images[0].getHeight(),this.getPosition()):3==this.selected&&this.fitCanvas.drawStretchToRect(a.width,a.height,this.images[0].getWidth(),this.images[0].getHeight(),this.getPosition())},c.prototype.destroy=function(){this.$methods.off(".CropResize"),this.$button.off(".CropResize"),this.$position.off(".CropResize"),this.$widthInput.off(".CropResize"),this.$heightInput.off(".CropResize")},c}(UI.Widgets.RsWidget));a.Fit=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.canvas=a,this.canvasWidth=120,this.canvasHeight=90,this.canvasPadding=5,this.context=this.canvas.getContext("2d")}return b.prototype.initCanvas=function(){this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#000000",this.context.fillRect(0,0,this.canvasWidth,this.canvasHeight)},b.prototype.getNewSize=function(a,b){var c=Math.min((this.canvasWidth-2*this.canvasPadding)/Math.max(a.width,b.width),(this.canvasHeight-2*this.canvasPadding)/Math.max(a.height,b.height));return{rect:{width:a.width*c,height:a.height*c},image:{width:b.width*c,height:b.height*c}}},b.prototype.getCalculatedPosition=function(a,b,c,d){var e={x:0,y:0},f={x:0,y:0};return b.height>=a.height?(f.y=d,e.y=0):(f.y=0,e.y=-d),b.width>=a.width?(f.x=c,e.x=0):(f.x=0,e.x=-c),{image:f,rect:e}},b.prototype.getStartCord=function(a,b,c){return 0==c?{rect:{x:0,y:0},image:{x:0,y:0}}:1==c?this.getCalculatedPosition(a,b,(b.width-a.width)/2,0):2==c?this.getCalculatedPosition(a,b,b.width-a.width,0):3==c?this.getCalculatedPosition(a,b,0,(b.height-a.height)/2):5==c?this.getCalculatedPosition(a,b,b.width-a.width,(b.height-a.height)/2):6==c?this.getCalculatedPosition(a,b,0,b.height-a.height):7==c?this.getCalculatedPosition(a,b,(b.width-a.width)/2,b.height-a.height):8==c?this.getCalculatedPosition(a,b,b.width-a.width,b.height-a.height):void 0},b.prototype.drawIntersect=function(a,b){this.context.setLineDash([]),this.context.fillStyle="gray",this.context.fillRect(Math.max(a.left,b.left),Math.max(a.top,b.top),Math.min(a.width,b.width),Math.min(a.height,b.height))},b.prototype.draw=function(a,b){this.context.strokeRect(a.left,a.top,a.width,a.height),this.context.strokeStyle="#FF0000",this.context.setLineDash([2]),this.context.strokeRect(b.left,b.top,b.width,b.height),this.drawIntersect(a,b)},b.prototype.render=function(a,b){this.initCanvas();var c=this.getStartCord(a.image,a.rect,b);this.draw({left:this.canvasPadding+c.rect.x,top:this.canvasPadding+c.rect.y,width:a.rect.width,height:a.rect.height},{left:this.canvasPadding+c.image.x,top:this.canvasPadding+c.image.y,width:a.image.width,height:a.image.height})},b.prototype.drawResizeAll=function(b,c,d,e,f){this.render(this.getNewSize({width:b,height:c},a.SizeCalculation.getFitSize(b,c,d,e)),f)},b.prototype.drawStretchToWidth=function(b,c,d,e,f){this.render(this.getNewSize({width:b,height:c},a.SizeCalculation.getStretchWidthSize(b,c,d,e)),f)},b.prototype.drawStretchToHeight=function(b,c,d,e,f){this.render(this.getNewSize({width:b,height:c},a.SizeCalculation.getStretchHeightSize(b,c,d,e)),f)},b.prototype.drawStretchToRect=function(b,c,d,e,f){this.render(this.getNewSize({width:b,height:c},a.SizeCalculation.getStretchRectSize(b,c,d,e)),f)},b}();a.FitMethodCanvas=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(){}return a.getFitSize=function(a,b,c,d){if(a>=c&&b>=d)return{width:c,height:d};var e=Math.min(a/c,b/d);return{width:c*e,height:d*e}},a.getStretchWidthSize=function(a,b,c,d){return{width:a,height:a/(c/d)}},a.getStretchHeightSize=function(a,b,c,d){return{width:b*(c/d),height:b}},a.getStretchRectSize=function(a,b,c,d){var e=Math.max(a/c,b/d);return{width:c*e,height:d*e}},a}();a.SizeCalculation=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c){void 0===c&&(c=!1),this.image=a,this.filterName=b,this.vignette=c,this.needRender=!1,this.oldFilter={name:"",parameters:[]}}return a.prototype.execute=function(){return this.oldFilter=this.image.filter,this.image.filter="reset"==this.filterName?null:{name:this.filterName,parameters:[this.vignette]},this.image.save()},a.prototype.unExecute=function(){return this.image.filter=this.oldFilter,this.image.save()},a}();a.FilterAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.image=null}return b.prototype.html=function(){return nunjucks.render("filters.html.njs",{})},b.prototype.viewType=function(){return 2},b.prototype.unSelectImage=function(){this.updateSelectState()},b.prototype.selectImage=function(){this.updateSelectState()},b.prototype.update=function(){this.updateSelectState(!0)},b.prototype.updateSelectState=function(a){if(void 0===a&&(a=!1),this.editor.selected().length>0){this.$el.show();var b=this.editor.selected()[0];(b!=this.image||a)&&(null!=this.widget&&this.widget.destroy(),this.image=b,this.initWidget()),null==this.widget&&this.initWidget()}else this.$el.hide()},b.prototype.initWidget=function(){var b=this,c="";null!=this.image.filter&&(c=this.image.filter.name),this.widget=new a.FiltersListWidget(this.$el,c),this.widget.draw(this.image),this.widget.on("filter",function(a){b.doAction(a.data.filter,a.data.vignette)}),this.widget.on("reset",function(){b.doAction("reset")})},b.prototype.init=function(a){this.$el=a,this.updateSelectState(!0)},b.prototype.deinit=function(){null!=this.widget&&(this.widget.destroy(),this.widget=null),this.editor.getInterface().clearPopover()},b.prototype.icon=function(){return"fa fa-filter"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"filter"},b.prototype.doAction=function(b,c){var d=this;void 0===c&&(c=!1),this.editor.getView().showLoading();var e=[];this.editor.selected().forEach(function(d){var f=new a.FilterAction(d,b,c);e.push(d.getActionDispatcher().process(f))}),Promise.all(e).then(function(){d.editor.getView().update()})},b}();a.FilterModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(a){function b(b,c,d,e){void 0===e&&(e=!1),a.call(this),this.$el=b,this.filterName=c,this.displayFilterName=d,this.isSelected=e,this.canvasWidth=50,this.render()}return __extends(b,a),b.prototype.render=function(){var a=this;this.$block=$(nunjucks.render("filter.html.njs",{filter:{name:this.filterName,displayName:this.displayFilterName}})),this.isSelected&&this.$block.addClass("selected"),this.$block.on("click.FilterWidget",function(b){"checkbox"!=$(b.target).attr("type")?a.trigger("select",{block:a.$block,name:a.filterName,vignette:a.$block.find("#mFilter-"+a.filterName+"-vignette").is(":checked")}):a.trigger("update",{block:a.$block,name:a.filterName,vignette:a.$block.find("#mFilter-"+a.filterName+"-vignette").is(":checked")})}),this.$el.append(this.$block)},b.prototype.draw=function(a,b,c){a.revert(),a[this.filterName]();var d=this.$block.find("canvas")[0];d.width=b,d.height=33;var e=d.getContext("2d");return e.fillRect(0,0,b,c),new Promise(function(b){a.render(function(){return e.putImageData(a.imageData,0,0),b(a)})})},b.prototype.destroy=function(){var a=this.$block.find("canvas")[0];a.width=1,a.height=1,a=null,this.$block.off(".FilterWidget"),this.$block.html("")},b}(UI.Widgets.RsWidget);a.FilterWidget=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(b){function c(a,c){void 0===c&&(c=""),b.call(this),this.$el=a,this.canvasWidth=50,this.filters=[],this.$filtersList=a.find(".m-filters__filters-list"),this.createFilter("lomo","Lomo",c),this.createFilter("vintage","Vintage",c),this.createFilter("clarity","Clarity",c),this.createFilter("sinCity","Sin City",c),this.createFilter("sunrise","Sunrise",c),this.createFilter("crossProcess","Cross Process",c),this.createFilter("orangePeel","Orange Peel",c),this.createFilter("love","Love",c),this.createFilter("grungy","Grungy",c),this.createFilter("jarques","Jarques",c),this.createFilter("pinhole","Pinhole",c),this.createFilter("oldBoot","Old Boot",c),this.createFilter("glowingSun","Glowing Sun",c),this.createFilter("hazyDays","Hazy Days",c),this.createFilter("herMajesty","Her Majesty",c),this.createFilter("nostalgia","Nostalgia",c),this.createFilter("hemingway","Hemingway",c),this.createFilter("concentrate","Concentrate",c)}return __extends(c,b),c.prototype.draw=function(a){var b=this,c=this.canvasWidth,d=a.height*this.canvasWidth/a.width;this.initCaman(a,c,d).then(function(a){var e=null;b.filters.forEach(function(b){e=null!=e?e.then(function(a){return b.draw(a,c,d)}):b.draw(a,c,d)})})},c.prototype.destroy=function(){this.filters.forEach(function(a){a.destroy()}),this.filters=[]},c.prototype.initCaman=function(a,b,c){return new Promise(function(d){new Core.ImageResizer(a.getImageData(),b,c).resize().then(function(a){var c=document.createElement("canvas"),e=c.getContext("2d");c.width=b,c.height=33,e.putImageData(a,0,0),Caman(c,function(){d(this)})})})},c.prototype.createFilter=function(b,c,d){var e=this,f=!1;d==b&&(f=!0),this.filters.push(new a.FilterWidget(this.$filtersList,b,c,f).on("select",function(a){e.selectFilter(a.data.block,a.data.name,a.data.vignette)}).on("update",function(a){e.setFilter(a.data.block,a.data.name,a.data.vignette)}))},c.prototype.setFilter=function(a,b,c){this.$el.find(".m-filter").removeClass("selected"),a.addClass("selected"),this.trigger("filter",{filter:b,vignette:c})},c.prototype.selectFilter=function(a,b,c){a.hasClass("selected")?(this.trigger("reset"),this.$el.find(".m-filter").removeClass("selected")):(this.$el.find(".m-filter").removeClass("selected"),a.addClass("selected"),this.trigger("filter",{filter:b,vignette:c}))},c}(UI.Widgets.RsWidget);a.FiltersListWidget=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c){this.image=a,this.prop=b,this.newValue=c,this.needRender=!1}return a.prototype.execute=function(){return this.oldValue=this.image[this.prop],this.image[this.prop]=this.newValue,this.image.save()},a.prototype.unExecute=function(){return this.image[this.prop]=this.oldValue,this.image.save()},a}();a.ImageAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.sliders={}}return b.prototype.html=function(){return nunjucks.render("image.html.njs",{})},b.prototype.viewType=function(){return 2},b.prototype.unSelectImage=function(){this.update()},b.prototype.selectImage=function(){this.update()},b.prototype.update=function(){var a=this.editor.selected();1==a.length?this.updateSlidersByImage(a[0]):a.length>0?this.updateSliders(a):this.setSlidersValue(0,"-")},b.prototype.updateSlidersByImage=function(a){_.map(this.sliders,function(b,c){b.set(a[c])})},b.prototype.setSlidersValue=function(a,b){void 0===b&&(b=""),_.map(this.sliders,function(c){c.set(a,b)})},b.prototype.updateSliders=function(a){_.map(this.sliders,function(b,c){var d=a[0][c];b.set(d);for(var e=0;e<a.length;e++)if(d!=a[e][c])return void b.set(0,"-")})},b.prototype.init=function(a){var b=this;a.find(".m__image-slider").each(function(a,c){var d=$(c);b.sliders[d.data("name")]=new UI.Widgets.RsSlider(d,d.data("min"),d.data("max"),d.data("step")).on("stopmove",function(a){b.doAction(a.widget.getElement().data("name"),a.data)})}),this.update()},b.prototype.deinit=function(){this.editor.getInterface().clearPopover()},b.prototype.icon=function(){return"fa fa-image"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"image"},b.prototype.doAction=function(b,c){var d=this;this.editor.getView().showLoading();var e=[];this.editor.selected().forEach(function(d){var f=new a.ImageAction(d,b,c);e.push(d.getActionDispatcher().process(f))}),Promise.all(e).then(function(){d.editor.getView().update()})},b}();a.ImageModule=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function a(a,b,c){this.image=a,this.width=b,this.height=c,this.needRender=!0}return a.prototype.execute=function(){return this.oldWidth=this.image.getWidth(),this.oldHeight=this.image.getHeight(),this.image.width=this.width,this.image.height=this.height,this.image.save()},a.prototype.unExecute=function(){return this.image.width=this.oldWidth,this.image.height=this.oldHeight,this.image.save()},a}();a.ResizeAction=b}(Modules||(Modules={}));var Modules;!function(a){var b=function(){function b(a){this.editor=a,this.isLocked=!0,this.image=null}return b.prototype.html=function(){return nunjucks.render("resize-single.dialog.html.njs",{isLocked:this.isLocked})},b.prototype.selectImage=function(){},b.prototype.unSelectImage=function(){},b.prototype.update=function(){},b.prototype.deinit=function(){this.editor.getInterface().clearPopover()},b.prototype.viewType=function(){return 0},b.prototype.init=function(a){var b=this;this.image=this.editor.selected()[0],this.$widthInput=a.find(".m__single-resize__val.width input"),this.$heightInput=a.find(".m__single-resize__val.height input"),this.$lock=a.find(".m__single-resize__lock"),this.$widthInput.val(this.image.width.toString()),this.$heightInput.val(this.image.height.toString());var c=_.debounce(function(){b.doAction(b.$widthInput.val(),b.$heightInput.val())},500);this.$lock.click(function(){b.isLocked?(b.isLocked=!1,b.$lock.find("i").attr("class","fa fa-unlock")):(b.isLocked=!0,b.updateSize(b.image),c(),b.$lock.find("i").attr("class","fa fa-lock"))}),this.$widthInput.on("input",function(){var a=parseInt(b.$widthInput.val());if(!isNaN(a)&&a>=50){b.isLocked&&b.$heightInput.val(Math.round(b.image.getOriginalImage().height*a/b.image.getOriginalImage().width)+"");var d=parseInt(b.$heightInput.val());!isNaN(d)&&d>=30&&c()}}),this.$heightInput.on("input",function(){var a=parseInt(b.$heightInput.val());if(!isNaN(a)&&a>=30){b.isLocked&&b.$widthInput.val(Math.round(b.image.getOriginalImage().width*a/b.image.getOriginalImage().height)+"");var d=parseInt(b.$widthInput.val());!isNaN(d)&&d>=50&&c()}})},b.prototype.updateSize=function(a){var b=parseInt(this.$widthInput.val()),c=parseInt(this.$heightInput.val());!isNaN(b)&&!isNaN(c)&&b>=50&&c>=30&&(b>c?this.$heightInput.val(Math.round(a.getOriginalImage().height*b/a.getOriginalImage().width)+""):this.$widthInput.val(Math.round(a.getOriginalImage().width*c/a.getOriginalImage().height)+""))},b.prototype.icon=function(){return"fa fa-expand"},b.prototype.type=function(){return 1},b.prototype.parent=function(){return null},b.prototype.name=function(){return"resize"},b.prototype.doAction=function(b,c){var d=this;this.editor.getView().showLoading();var e=new a.ResizeAction(this.image,b,c);this.image.getActionDispatcher().process(e).then(function(){d.editor.getView().update()})},b}();a.ResizeModule=b}(Modules||(Modules={}));